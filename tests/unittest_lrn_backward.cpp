#include "unittest_main.h"
#include <common/fixedpoint.h>

#include <time.h>
#include <sys/time.h>
#include <stdlib.h>

double get_wall_time(){
    struct timeval time;
    if (gettimeofday(&time,NULL)){
        //  Handle error
        return 0;
    }
    return (double)time.tv_sec + (double)time.tv_usec * .000001;
}

using namespace std;
using namespace minerva;

#ifdef HAS_CUDA


TEST(LRNBackward, GpuWithoutPaddingSmall) {
  element_t bottom_raw[] = {1,2,3,4,5,6,7,8};
  element_t top_raw[] = {.1,.2,.3,.4,.5,.6,.7,.8};
  element_t top_diff_raw[] = {8,6,4,2,0,-2,-4,-6};
  element_t correct_raw[] = {7.820000,5.460000,3.190000,1.280000,-0.900000,-2.000000,-1.480000,1.200000};
  Scale bottom_size{2, 2, 2, 1};

  auto& ms = MinervaSystem::Instance();
  shared_ptr<element_t> bottom_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_diff_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  memcpy(bottom_ptr.get(), bottom_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_ptr.get(), top_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_diff_ptr.get(), top_diff_raw, bottom_size.Prod() * sizeof(element_t));
  ms.SetDevice(cpu_device);
  ImageBatch bottom = NArray::MakeNArray(bottom_size, bottom_ptr);
  ImageBatch top = NArray::MakeNArray(bottom_size, top_ptr);
  ImageBatch top_diff = NArray::MakeNArray(bottom_size, top_diff_ptr);
  NArray scale = NArray::Ones(bottom_size);
  int local_size = 2;
  element_t alpha = 0.3;
  element_t beta = 0.75;
  ms.SetDevice(gpu_device);
  ImageBatch bottom_diff = Convolution::LRNBackward(bottom, top, scale, top_diff, local_size, alpha, beta);
  auto bottom_diff_ptr = bottom_diff.Get();
  for (int i = 0; i < bottom_size.Prod(); ++i) {
    EXPECT_NEAR(bottom_diff_ptr.get()[i], correct_raw[i], 0.001);
    //printf("%f,",bottom_diff_ptr.get()[i]);
  }
}




TEST(LRNBackward, GpuLargeFracWide) {
  element_t bottom_raw[] = {8.59232186e-01, -3.67248891e-01, -6.32162377e-01, -5.90879443e-01, 1.35450058e-01, 1.91089406e-01, 9.29029039e-01, 3.06354194e-01, 4.97813275e-01, 3.07139742e-01, 4.95429619e-01, 9.22613472e-01, -9.83223404e-01, -7.87111247e-01, -4.02592572e-01, 3.12822366e-01, 6.19625105e-01, 7.44351827e-01, 9.29295195e-01, 4.47370694e-01, 2.84950656e-01, 4.34907242e-01, -6.48019856e-02, -3.48830645e-01, -1.20710788e-01, 4.59378165e-01, 9.88029172e-01, 3.53747424e-01, 5.81645036e-01, -6.58171484e-01, -9.46301448e-01, 6.00740488e-01, 8.07445076e-01, -9.50647579e-01, -1.65053631e-02, 5.25103347e-02, 1.92732021e-01, -8.96084910e-01, 7.90179056e-01, 4.56532361e-01, 6.36700023e-01, 4.45505669e-04, 6.20378818e-01, -8.08062949e-01, -5.62099913e-01, -4.82561877e-01, -6.37884921e-02, -8.12535948e-02, 4.19019560e-01, -6.43893988e-01, 6.28997687e-02, -6.64515542e-01, 5.37627837e-01, 8.56341098e-01, 2.18987316e-01, -6.99633011e-01, -2.07465926e-02, -2.45310092e-01, 6.97202824e-01, 8.22194457e-01, -2.32302558e-01, -3.69008193e-01, 1.36788306e-01, -6.24363930e-01, -7.48316912e-01, 3.75191610e-01, 5.99213436e-01, 1.47073130e-01, 9.46459963e-01, 2.68108754e-01, 7.76843450e-01, -9.17048249e-03, -2.96766940e-01, 4.28460737e-01, 7.85823290e-03, -5.48724787e-01, -5.10051120e-01, 5.85601400e-01, -9.65517098e-03, 8.30187347e-01, 8.90743668e-01, 6.64644593e-02, -4.95014811e-01, 4.41724116e-01, -2.65122472e-01, -2.70311418e-03, -5.46849905e-01, -2.92868707e-01, 3.01703573e-01, -3.74134209e-01, 5.37470894e-01, 5.63674207e-01, 7.04818966e-01, 8.99811480e-01, -7.85354176e-01, 8.21450712e-01, -3.27889676e-01, 6.52760854e-01, 7.96201270e-01, -9.14569391e-01, -6.08410002e-01, -4.10997356e-01, 2.53999761e-01, -8.27553790e-01, -7.14109960e-01, 3.16530385e-02, 3.78682659e-01, 7.13251622e-01, 2.94723367e-01, 1.63237351e-01, 4.22231910e-01, -4.95166286e-01, 8.00319367e-01, -1.15412614e-01, -9.58958351e-01, 9.19322028e-01, 3.04450845e-01, 2.64125002e-02, 3.64712766e-01, -2.09192187e-02, 8.52980343e-01, 3.17595443e-02, -8.55680237e-01, 1.35016596e-01, 2.30486367e-01, 8.83092589e-01, -1.69273291e-01, -4.71120051e-01, -8.05213669e-01, -2.83115562e-02, -7.06742743e-02, -9.40481366e-01, 3.88554924e-01, 4.33894225e-01, 4.59622847e-01, -1.71297966e-01, -9.69802310e-01, 8.17950315e-01, 5.78757436e-01, -6.69601662e-01, -3.74428077e-01, 2.21890612e-01, -2.71019427e-01, -6.87922822e-01, -6.45392373e-01, 7.35779342e-01, -4.19810663e-01, 1.70359243e-01, -9.20102482e-02, -1.77643736e-01, 7.65268890e-01, 3.85416030e-01, -4.41453290e-01, -8.71119538e-01, -6.02752772e-01, 8.63365489e-01, 7.08827136e-01, 9.09469469e-01, -8.95493304e-01, 1.58943361e-01, -3.90074667e-02, -9.56582042e-01, -2.52759073e-01, -1.71816398e-01, 2.07814468e-01, 3.43497455e-01, 6.77731401e-01, 5.59052417e-01, -1.98597912e-01, 5.89058463e-01, 7.86248621e-01, -4.75020618e-01, 9.78394015e-01, 7.06614198e-01, 4.62954312e-01, -2.88868751e-01, 7.66578981e-01, 7.35918182e-01, 9.11532892e-01, -9.99785487e-01, -9.66917916e-01, -3.71859885e-01, 9.90632349e-01, -7.02311554e-01, -6.65245763e-01, 5.17144074e-01, -8.60940668e-01, 4.10946877e-01, -6.16694364e-02, -9.79623568e-01, 5.49647726e-01, 5.88402017e-01, -7.00861097e-01, -9.52592736e-01, 5.24127542e-01, -5.52659640e-01, -4.75651204e-01, -8.62609944e-02, -5.00146163e-01, 1.36567123e-01, 6.93885994e-01, -2.43800926e-01, -1.35069767e-01, 6.65238353e-01, -2.57736129e-01, -9.18893456e-01, 1.09342972e-01, -9.75075144e-02, 4.50601953e-01, -2.43098955e-01, 6.81324991e-01, -6.13706128e-02, 1.25286858e-01, 3.22398678e-01, -7.55162650e-02, 2.47273891e-01, -5.56238738e-01, 4.65726234e-01, -2.36635823e-01, -6.10330916e-01, -4.57674450e-01, -5.01549896e-01, -6.95721875e-01, 5.42747408e-01, -4.89176535e-01, -7.44913190e-01, 3.30334307e-01, -1.74390103e-01, 3.35535533e-01, 3.19627034e-01, -3.89244656e-01, -5.97551518e-01, -5.55945747e-01, -7.60058273e-01, -9.25709118e-01, -9.31736833e-01, -5.39006904e-01, -5.43292587e-01, 2.49821244e-01, 7.85122371e-01, 5.59456032e-01, 4.42902537e-01, -3.79115682e-01, -2.73833167e-01, -6.07836432e-01, 8.70983596e-01, 1.23468000e-01, 6.34583074e-01, -3.02172038e-01, 5.99428526e-01, -7.91791075e-01, 4.24240330e-01, 8.34896992e-01, 6.07170737e-01, -3.45773707e-01, -4.89785641e-01, -9.99565129e-03, -1.72778091e-01, -1.50125809e-01, -8.51243390e-01, 2.06781303e-01, 4.94399467e-01, 5.95152453e-01, -2.36998955e-01, 5.94316306e-01, -5.64052608e-02, 4.42798342e-01, -6.21574621e-01, -1.30808581e-01, 6.46936218e-01, 6.52545256e-01, -6.20949033e-01, -9.59795660e-01, 4.06982772e-01, -3.05459761e-01, -1.60992368e-01, 5.36177806e-01, 9.25756133e-01, 7.85130614e-01, -7.30115467e-01, 5.95609430e-01, 3.64181215e-01, 6.01057742e-02, 7.31963310e-01, 5.06496191e-01, -8.13594826e-01, -3.41121136e-01, -1.75274609e-01};
  element_t top_raw[] = {9.508410415471417, -0.16577359468444186, 1.733487483269709, 9.348087491495974, -0.6363412119477747, 2.067057633053741, -4.1052398063235, -4.453070247027213, -9.817630059136809, -9.745100714613839, 8.507675533911446, 7.314343359317451, 9.805494998370659, 9.712134857051403, 2.745197189184328, -5.72670371128603, 8.54729452815252, -6.922344067868784, -3.432557259022766, 8.076599054245325, 7.980351773032467, 4.101995507376056, -8.887660144637092, 8.594494202367066, -4.945814105818405, 0.7834925569681879, -9.895184123041181, 3.650076839977796, -2.6584232147619, 1.378218295559888, -0.28197498175339497, -0.5389973392195522, -5.304106155169079, -1.9503419350996722, -0.4733994809474886, -5.606773618321855, -2.109972490445429, 3.173041549480562, 7.568158297689685, 0.9341922712859034, -2.0335123420166568, -9.269985087520213, 8.836019808463867, 4.686137671467488, -1.5173406474800615, 5.924600196994643, 3.619414402133982, -6.284484898516611, 1.8965408539423407, 7.378421858682501, -6.578883609210431, 4.590914408946167, -6.96467498182442, 2.105449592913679, -9.196658776632813, 2.935171074943801, 8.478216602599417, -1.0951766272795833, -8.334124804291703, 3.593083204489533, -6.657835310915758, -5.569209529942327, -9.596650356757756, -7.394717983866825, 7.9378544580582755, 3.784090493555169, -9.394259327330271, 0.01187386304137128, 6.42206488077958, 7.316305126689173, 0.11740011066576983, 0.3646290441852713, 5.068378350350976, -1.6000117793441309, -5.00179502523622, -2.911429048685001, 0.5893043592076381, 3.7601152255375307, -8.349090556175959, 0.7627856619201356, 0.5178195007014619, -0.805835082525741, 9.123172082230084, -3.2535595638440302, -5.884199208010092, -5.961437402432717, -8.699160771019546, -4.025122941134596, 3.0779153010229, -8.639034153253762, 8.117123538307467, 1.52021019128272, -5.020459007963547, 5.959527948284196, 0.6343437249976205, -7.967269052535215, -9.139448095269662, 3.0264736272496773, 6.9941524102828865, 1.5143771329289795, -0.5665745182084514, 9.705378256776008, -2.443353901013408, -2.2417371424569943, 0.423326701058091, 1.05269672533721, 6.229017006663099, 7.661436414881592, 5.194508853664992, -8.728361420562303, -0.1409048217250657, -3.3848293138393704, 1.4511150489153675, -3.4067415147228637, -3.4192509254728325, -5.632188963130062, 1.0593747233354023, 4.477300319272786, 9.985821668579021, 2.965139818159237, 0.8722680868992043, 0.4426056345579994, -8.964467362228648, 3.743997389339299, 8.320944681751136, 9.94965188451176, 2.4403038187096655, 0.8261633144259157, 1.8892358764513553, 8.310778302020427, -1.8394290988749908, -1.449857502624372, -3.652841857891329, -1.2953305680930107, 6.4106768433141, 7.255459260174241, -4.3495119530510795, 9.003811142180336, 0.5719790780886651, -2.8402997558910865, 3.414709080934921, 7.799434703643804, 1.3803438174202824, -9.402361541786878, -9.26508354271909, 9.286288092689034, -3.9292684491952574, 1.3336919109662055, 2.0183118892657284, -8.102967061383247, -3.605029904308548, -5.633490567773249, -2.896733128862725, -9.727717193364924, 5.893469845994261, 9.365569922765246, 0.5805042383823675, 9.40894899413641, 3.819435324096233, -5.008732738875203, -9.522249879468237, -9.924084367357759, 4.925033491140827, 8.144638083026493, 6.277810442050239, -8.656159350341063, 9.370167318857362, -4.4484878717511585, 2.730794588280963, 8.90379750337441, 9.47652699937947, -1.9817887709231048, -3.027946878437298, -9.25828843568995, -3.109590840485133, 0.7725520310019576, -9.454118914529799, -5.111335647880537, -1.6927630058732497, -9.550543519856491, 6.767317694415265, 1.5802471282832329, 9.295335992263464, 0.2369059567278402, -8.26927093114698, -4.46774299786208, 0.636490608069451, 8.305525675342771, 7.280296899010764, -6.409938669506515, -3.4417595849717824, 5.077266800866283, -4.222495107902939, 7.225490847110056, -2.813594135896526, 6.961609195042463, -4.470301120014524, 7.432624872222444, -3.1451101112703395, -9.453073083239845, -3.6034852788531673, -8.892143232132966, 4.8750808632659925, 7.181250643445821, -9.094977383686693, 2.8756459175146247, 3.4642197461807633, 2.92157383978366, 3.5644355351018326, 9.292909832188737, -6.7849153572533965, -8.33014980932533, -3.385009646174007, -2.8531792268759126, -8.880978679828766, 8.041289496932507, -8.098484669716422, 0.9305315174208406, 4.8782933953447145, -7.44113558157842, 7.89054745502585, 2.36916539945412, -0.22477979466682285, 0.9916610367784688, 7.645688665370372, -6.05954572693125, -0.5556711281748186, -4.607930162061031, -3.356272591950127, -4.127069392240594, 8.338014426870483, -2.441145096557376, -7.31080834626876, -8.975331385484504, -4.629510200280816, 9.931627452722445, 6.868121491643432, 7.986427472131712, 4.277098725516339, -5.050784369994452, -4.367853059137074, 4.375012486723058, 0.5125212518772297, -0.260844848106343, -0.0103310129978329, 9.968537412376545, 9.089613922677955, -5.135186108757079, 4.161957271180192, -1.8466071092172776, 5.28261238490199, -0.42784431234050224, 8.517987313096246, 4.849326232347986, 6.667591868674595, 7.885755961164698, -9.557980841151812, -9.449415774764411, 2.6872736314179875, -6.475911174986184, -6.322829333811855, -8.744155269259009, -7.6630808868123985, 5.730700696083925, -3.536637325927357, 1.9326725032011538, -2.937285199388519, -9.942192766279604, 1.4994802270363667, -1.0919822924346292, -7.146807319510757, 6.05517100781832, -9.993131372370968, -3.8470901140496245, -8.369082270259723, 0.7312579183444079, 7.75714726041441, 3.8008959632344492, -4.060245222408721, -0.27371509911184333, 0.5955897798125278, 5.94991328358134, -3.802041047671489, 0.37269344852454367, 7.068149403492107, -9.051855305170768, -9.04019188982522, 3.58496495616766};
  element_t top_diff_raw[] = {0.9605420224678962, -0.4424035607799859, -0.4758491338440063, 0.06789283732525808, 0.19162035294098967, 0.30690956484492027, -0.940936047281109, 0.2330264810867324, -0.3016190672143686, -0.49999632241666014, -0.9260381248879774, -0.655426698121168, 0.3861219893507599, 0.7132316445934401, 0.2790513100750276, 0.7314540755646044, -0.9389795070071631, -0.11231397032883805, -0.998696777101441, -0.5805895824420018, 0.7152729145384573, 0.43328525619797675, -0.664211865455189, -0.7825664056858019, -0.6226231338171733, 0.7257665448243393, 0.7246010725192578, -0.8775131958204172, 0.8804977722528609, -0.480576882856421, -0.8635935083961668, -0.5129793690997058, -0.6900441930380132, -0.13095916119689988, -0.13769723767728248, -0.6749799909693035, 0.4994933231079588, 0.7982032147186442, -0.06173537920119787, 0.6209870939404936, -0.6275483455400741, 0.8917797407556691, 0.9049734704548771, -0.31254348513273467, -0.8051725636549991, -0.823336616499482, 0.11498872926835979, -0.31287512282157115, 0.050658030194949966, -0.12197599715241281, -0.07349427521764174, 0.5837854024771634, -0.40470478549350597, -0.3036063596258627, 0.12931661539362205, -0.403846043946249, -0.6579572110315717, 0.15415979767612775, 0.5535716927052428, -0.3636228087719817, -0.033660031417017455, -0.8086298033669534, 0.27420778240142973, -0.4555660450484966, 0.10072239858430021, -0.6105314946174363, -0.8919475637136256, 0.24892523853876702, 0.2931925647215756, -0.32312905247789425, -0.4083936506409991, 0.5848149194580408, 0.8546596078273458, 0.4129263489794388, -0.17933100063302287, 0.19167765076414356, -0.8090961848765683, 0.43988030994660776, -0.5289207202662802, -0.7020223121417597, 0.9345281909973493, -0.9110093726544732, -0.20056186769904816, -0.2380210669815226, -0.5444897288468453, -0.05883528228564039, -0.9998567568569068, 0.3881185652952639, -0.23304746448048896, -0.8926999106293347, 0.8053618909409004, 0.9366583904130057, 0.11978040976155757, 0.17061725007560447, 0.7869585504602716, -0.13844559572477277, 0.061419166165267214, -0.2542625782598511, 0.5508464025794673, -0.6769208212574807, -0.7937162551770061, 0.31720779953879275, 0.9957292691957946, 0.3450045647378901, -0.3747671933809058, 0.7068237737737753, -0.8335251881627046, 0.5113491823483021, 0.24652288509112563, -0.9447322568994927, -0.7577175757886505, 0.6631422412305061, 0.25181161470317237, -0.8352692806066693, 0.10952923058084951, -0.1755139871870881, 0.7562468028545362, -0.9967850683202153, 0.11067475161835194, 0.18536550692970155, 0.49746815158819935, -0.5585688225854801, -0.32416773714443026, 0.5254147791882013, 0.8703880509675663, 0.053114827961885824, 0.20267762055979954, 0.4396392907953912, -0.3636570058143651, 0.46711888764610343, 0.5794108535722506, -0.9013497086985776, -0.9761074699917867, -0.5507946354554059, 0.7662577566397222, -0.46842124263937235, 0.558501320852669, 0.18791417241990027, -0.13299941870198384, 0.9546431391270762, 0.2536911220630662, -0.985573468729479, 0.9645898805871109, 0.8471287232672131, -0.30992765528455357, 0.9255296271546931, 0.408909308029755, -0.8175275408352287, 0.286434137448466, -0.6304386778047857, -0.7024566486300181, -0.7600046999721697, -0.4543977065577136, -0.22671628265183652, -0.9436588906961636, -0.7073248847286357, 0.7594354613172043, -0.9735049210226274, -0.37489242870467665, -0.14999428197843812, -0.7015857464583517, -0.9358079147589888, -0.12811063792835076, 0.9591986635791117, 0.5080789468622531, -0.8100877396536785, 0.8966716176806893, 0.11622085929102388, 0.9113345343375046, -0.11068872821622411, -0.17454348245320173, -0.24731132465504957, 0.6437288904782619, 0.6880140828709671, -0.7479202770880864, -0.6976801069852692, -0.7147498976590811, -0.04983088781825562, -0.8760541641058, -0.6245376519148145, -0.8333560894860677, -0.820820663925236, 0.7671411676655433, -0.755549667479188, -0.9065361750585321, -0.23742520585428872, 0.12512284871529955, -0.6814457891745571, 0.29676097822517966, -3.9241414275581477e-05, -0.4016551794607719, 0.5610256401224614, 0.6472969950566201, -0.6439231107637391, -0.30024707039247334, -0.1017277539035144, 0.4863249620465595, -0.7320549369412559, 0.0018357224610157097, 0.6984118870282814, 0.20008262679857736, 0.6892660306716014, -0.9026964636021966, -0.939271628282619, 0.2758140980719217, 0.15907590657935722, 0.7515773186283592, 0.7967363846808262, 0.31697875420933985, -0.6023264321460904, -0.6323953100724993, -0.8166626509341592, 0.36444595559000237, 0.13573276058546102, -0.002600913432136087, 0.29523610343466444, 0.7248882089358886, -0.3531164576527981, 0.9335310755889759, 0.8406457925952882, -0.9218464807360469, -0.5934512842137265, -0.6972478549694163, 0.7246618195337531, -0.17638503570150332, -0.9540555383965676, 0.7200475715256784, -0.4796959818685398, -0.5294121583774094, -0.05671101151782132, -0.3990738986185889, -0.9111967569182617, 0.13518716050257962, -0.8240754772306595, -0.9419255350708233, -0.047913243871074984, 0.2160731914052918, 0.6132057610123631, -0.1483252161201276, 0.19962989834879563, 0.6526343893985262, -0.8377169376092328, 0.03945193428795757, 0.27137889212789257, 0.1254944766988415, -0.11771942536833913, -0.13740686337107322, -0.5617675251685137, 0.7032288492162357, 0.3016023307491442, 0.42197761108254017, -0.053616332405617584, -0.3145510508749696, -0.2503780894118248, 0.2669926760177723, 0.5704371802330073, 0.19636321444910387, -0.4726987562736813, -0.24409857803712587, 0.3209578788465337, -0.2781242597283762, -0.731271758673744, -0.25742285693936906, -0.19484669042501412, -0.9487497099037259, 0.010501603004986926, 0.6366449293224656, -0.5531530109672302, -0.8153968729184686, -0.24072727422210471, 0.44127442597785604, 0.5289394518327108, 0.6732742001684444, 0.09167116721042223, 0.6164136997871228, 0.7466988414130609, 0.8702285480412169, -0.3711391335124672, -0.7152358089356634, 0.07060778034488058, 0.7076486005045513, 0.9152177676390709, 0.02010862154499593, -0.6176471433654322, -0.1912732947556457, 0.5987034646879414, -0.6248674687294185, 0.054391483184376366};
  element_t correct_raw[] = {-0.805160,-0.436343,-0.593177,0.152271,0.195337,0.279633,-1.748376,0.304554,-0.633295,-0.836718,-0.047816,0.339754,1.223707,1.940004,0.348443,1.026284,0.179934,-0.242525,-1.715480,-0.108583,0.349302,0.259366,-0.578139,-1.310451,-0.538987,0.666993,2.318553,-0.622577,1.186830,-0.578662,-0.811746,-0.550352,-1.354987,-0.076327,-0.137455,-0.719693,0.545196,1.308850,0.021332,0.561397,-0.810363,0.892608,-0.211201,-0.578833,-0.650658,-1.352966,0.120962,-0.276928,-0.819475,-0.241738,-0.068663,1.079398,-0.730915,-0.302676,-0.002412,-0.753791,-0.670174,0.413778,2.513195,0.764940,0.175946,0.140403,0.331621,-0.570767,-1.115965,-0.481133,-2.483840,0.404000,-1.323344,-0.287732,-1.431848,0.571377,1.349519,0.421801,-0.168240,-0.272673,-1.132441,0.309219,-0.518798,-0.653644,0.104002,-0.925807,-0.397097,-0.691118,-0.416239,-0.057082,0.012858,0.323402,-0.270983,-0.939396,-0.952198,0.941821,0.021400,0.952335,0.948713,-0.705732,0.027094,-0.009060,-0.225966,-0.336359,-0.346306,0.542789,1.202738,-0.019717,-1.296551,0.702727,0.001945,0.092309,0.146744,-1.412997,-0.517865,0.788388,0.042041,-0.821370,1.836664,-0.380600,0.572385,-0.956213,0.023918,0.188956,-0.417161,-0.552081,0.408010,0.482608,0.519525,-0.380534,0.389705,0.421377,-0.400456,0.496525,0.533367,-0.460941,-1.567926,-0.654689,-0.641237,-0.659622,-0.128084,-1.542789,-0.974373,0.760660,0.276010,-0.652565,1.076223,-0.214986,0.107053,-0.497332,0.257143,-0.775734,0.298402,-0.426256,-1.138495,-1.131289,-0.323657,0.205553,-1.697896,0.579532,0.689125,0.900842,-0.663396,-0.176862,-0.642952,1.063050,-0.163993,1.261213,0.358938,-1.352043,-0.384540,0.181254,1.022539,0.019934,0.118071,-0.194928,1.072818,1.700742,-0.990179,-0.732712,-1.880256,-0.092005,-1.180200,0.717226,-2.060285,-0.929347,-0.822267,-0.783834,0.215526,-0.360852,0.140550,-0.158127,0.326739,0.000016,-0.572618,0.183914,0.669106,0.200995,-0.210392,-0.325371,0.315529,-0.738512,0.286162,0.769720,0.107146,0.474035,-1.205453,1.061879,0.155909,-1.640115,0.722750,0.864287,-0.474895,-0.400512,-1.193436,-0.614850,0.309308,-0.344841,0.140551,0.191915,0.301640,-0.215410,1.087934,0.048937,-1.871606,-1.470942,-0.308651,0.702726,0.418927,0.057585,0.639565,-0.158924,-0.237793,0.019739,-0.065976,-0.636199,0.949267,0.622201,-0.017081,-1.334190,0.658069,1.211890,-0.190370,-0.125444,1.355512,-0.008834,0.113237,0.223384,-0.172009,1.178549,-0.102550,-0.030999,0.853199,1.203352,0.035105,0.588046,0.659999,-0.147000,0.608050,1.322680,0.194683,-0.516652,-0.121322,1.225826,-0.302545,-1.399499,-0.524673,-0.127792,-0.612426,0.006589,0.369236,-0.658856,-1.065467,-0.074335,0.881298,1.076817,-1.070922,-0.405421,0.234357,0.846546,-0.158510,-0.126057,-0.640431,0.432842,0.783615,-0.137051,-0.037830,-0.501367,-0.206324,0.503137,-0.239992,0.022318};

  auto& ms = MinervaSystem::Instance();
  Scale bottom_size{8, 6, 3, 2};
  shared_ptr<element_t> bottom_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_diff_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  memcpy(bottom_ptr.get(), bottom_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_ptr.get(), top_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_diff_ptr.get(), top_diff_raw, bottom_size.Prod() * sizeof(element_t));
  ms.SetDevice(cpu_device);
  ImageBatch bottom = NArray::MakeNArray(bottom_size, bottom_ptr);
  ImageBatch top = NArray::MakeNArray(bottom_size, top_ptr);
  ImageBatch top_diff = NArray::MakeNArray(bottom_size, top_diff_ptr);
  ImageBatch scale = NArray::Ones(bottom_size);
  int local_size = 2;
  element_t alpha = 0.3;
  element_t beta = 0.75;
  ms.SetDevice(gpu_device);
  ImageBatch bottom_diff = Convolution::LRNBackward(bottom, top, scale, top_diff, local_size, alpha, beta);
  auto bottom_diff_ptr = bottom_diff.Get();
  for (int i = 0; i < bottom_size.Prod(); ++i) {
    EXPECT_NEAR(bottom_diff_ptr.get()[i], correct_raw[i], 0.001);
    //printf("%f,",bottom_diff_ptr.get()[i]);
  }
}


TEST(LRNBackward, GpuLargeFracLong) {
  element_t bottom_raw[] = {8.59232186e-01, -3.67248891e-01, -6.32162377e-01, -5.90879443e-01, 1.35450058e-01, 1.91089406e-01, 9.29029039e-01, 3.06354194e-01, 4.97813275e-01, 3.07139742e-01, 4.95429619e-01, 9.22613472e-01, -9.83223404e-01, -7.87111247e-01, -4.02592572e-01, 3.12822366e-01, 6.19625105e-01, 7.44351827e-01, 9.29295195e-01, 4.47370694e-01, 2.84950656e-01, 4.34907242e-01, -6.48019856e-02, -3.48830645e-01, -1.20710788e-01, 4.59378165e-01, 9.88029172e-01, 3.53747424e-01, 5.81645036e-01, -6.58171484e-01, -9.46301448e-01, 6.00740488e-01, 8.07445076e-01, -9.50647579e-01, -1.65053631e-02, 5.25103347e-02, 1.92732021e-01, -8.96084910e-01, 7.90179056e-01, 4.56532361e-01, 6.36700023e-01, 4.45505669e-04, 6.20378818e-01, -8.08062949e-01, -5.62099913e-01, -4.82561877e-01, -6.37884921e-02, -8.12535948e-02, 4.19019560e-01, -6.43893988e-01, 6.28997687e-02, -6.64515542e-01, 5.37627837e-01, 8.56341098e-01, 2.18987316e-01, -6.99633011e-01, -2.07465926e-02, -2.45310092e-01, 6.97202824e-01, 8.22194457e-01, -2.32302558e-01, -3.69008193e-01, 1.36788306e-01, -6.24363930e-01, -7.48316912e-01, 3.75191610e-01, 5.99213436e-01, 1.47073130e-01, 9.46459963e-01, 2.68108754e-01, 7.76843450e-01, -9.17048249e-03, -2.96766940e-01, 4.28460737e-01, 7.85823290e-03, -5.48724787e-01, -5.10051120e-01, 5.85601400e-01, -9.65517098e-03, 8.30187347e-01, 8.90743668e-01, 6.64644593e-02, -4.95014811e-01, 4.41724116e-01, -2.65122472e-01, -2.70311418e-03, -5.46849905e-01, -2.92868707e-01, 3.01703573e-01, -3.74134209e-01, 5.37470894e-01, 5.63674207e-01, 7.04818966e-01, 8.99811480e-01, -7.85354176e-01, 8.21450712e-01, -3.27889676e-01, 6.52760854e-01, 7.96201270e-01, -9.14569391e-01, -6.08410002e-01, -4.10997356e-01, 2.53999761e-01, -8.27553790e-01, -7.14109960e-01, 3.16530385e-02, 3.78682659e-01, 7.13251622e-01, 2.94723367e-01, 1.63237351e-01, 4.22231910e-01, -4.95166286e-01, 8.00319367e-01, -1.15412614e-01, -9.58958351e-01, 9.19322028e-01, 3.04450845e-01, 2.64125002e-02, 3.64712766e-01, -2.09192187e-02, 8.52980343e-01, 3.17595443e-02, -8.55680237e-01, 1.35016596e-01, 2.30486367e-01, 8.83092589e-01, -1.69273291e-01, -4.71120051e-01, -8.05213669e-01, -2.83115562e-02, -7.06742743e-02, -9.40481366e-01, 3.88554924e-01, 4.33894225e-01, 4.59622847e-01, -1.71297966e-01, -9.69802310e-01, 8.17950315e-01, 5.78757436e-01, -6.69601662e-01, -3.74428077e-01, 2.21890612e-01, -2.71019427e-01, -6.87922822e-01, -6.45392373e-01, 7.35779342e-01, -4.19810663e-01, 1.70359243e-01, -9.20102482e-02, -1.77643736e-01, 7.65268890e-01, 3.85416030e-01, -4.41453290e-01, -8.71119538e-01, -6.02752772e-01, 8.63365489e-01, 7.08827136e-01, 9.09469469e-01, -8.95493304e-01, 1.58943361e-01, -3.90074667e-02, -9.56582042e-01, -2.52759073e-01, -1.71816398e-01, 2.07814468e-01, 3.43497455e-01, 6.77731401e-01, 5.59052417e-01, -1.98597912e-01, 5.89058463e-01, 7.86248621e-01, -4.75020618e-01, 9.78394015e-01, 7.06614198e-01, 4.62954312e-01, -2.88868751e-01, 7.66578981e-01, 7.35918182e-01, 9.11532892e-01, -9.99785487e-01, -9.66917916e-01, -3.71859885e-01, 9.90632349e-01, -7.02311554e-01, -6.65245763e-01, 5.17144074e-01, -8.60940668e-01, 4.10946877e-01, -6.16694364e-02, -9.79623568e-01, 5.49647726e-01, 5.88402017e-01, -7.00861097e-01, -9.52592736e-01, 5.24127542e-01, -5.52659640e-01, -4.75651204e-01, -8.62609944e-02, -5.00146163e-01, 1.36567123e-01, 6.93885994e-01, -2.43800926e-01, -1.35069767e-01, 6.65238353e-01, -2.57736129e-01, -9.18893456e-01, 1.09342972e-01, -9.75075144e-02, 4.50601953e-01, -2.43098955e-01, 6.81324991e-01, -6.13706128e-02, 1.25286858e-01, 3.22398678e-01, -7.55162650e-02, 2.47273891e-01, -5.56238738e-01, 4.65726234e-01, -2.36635823e-01, -6.10330916e-01, -4.57674450e-01, -5.01549896e-01, -6.95721875e-01, 5.42747408e-01, -4.89176535e-01, -7.44913190e-01, 3.30334307e-01, -1.74390103e-01, 3.35535533e-01, 3.19627034e-01, -3.89244656e-01, -5.97551518e-01, -5.55945747e-01, -7.60058273e-01, -9.25709118e-01, -9.31736833e-01, -5.39006904e-01, -5.43292587e-01, 2.49821244e-01, 7.85122371e-01, 5.59456032e-01, 4.42902537e-01, -3.79115682e-01, -2.73833167e-01, -6.07836432e-01, 8.70983596e-01, 1.23468000e-01, 6.34583074e-01, -3.02172038e-01, 5.99428526e-01, -7.91791075e-01, 4.24240330e-01, 8.34896992e-01, 6.07170737e-01, -3.45773707e-01, -4.89785641e-01, -9.99565129e-03, -1.72778091e-01, -1.50125809e-01, -8.51243390e-01, 2.06781303e-01, 4.94399467e-01, 5.95152453e-01, -2.36998955e-01, 5.94316306e-01, -5.64052608e-02, 4.42798342e-01, -6.21574621e-01, -1.30808581e-01, 6.46936218e-01, 6.52545256e-01, -6.20949033e-01, -9.59795660e-01, 4.06982772e-01, -3.05459761e-01, -1.60992368e-01, 5.36177806e-01, 9.25756133e-01, 7.85130614e-01, -7.30115467e-01, 5.95609430e-01, 3.64181215e-01, 6.01057742e-02, 7.31963310e-01, 5.06496191e-01, -8.13594826e-01, -3.41121136e-01, -1.75274609e-01};
  element_t top_raw[] = {9.508410415471417, -0.16577359468444186, 1.733487483269709, 9.348087491495974, -0.6363412119477747, 2.067057633053741, -4.1052398063235, -4.453070247027213, -9.817630059136809, -9.745100714613839, 8.507675533911446, 7.314343359317451, 9.805494998370659, 9.712134857051403, 2.745197189184328, -5.72670371128603, 8.54729452815252, -6.922344067868784, -3.432557259022766, 8.076599054245325, 7.980351773032467, 4.101995507376056, -8.887660144637092, 8.594494202367066, -4.945814105818405, 0.7834925569681879, -9.895184123041181, 3.650076839977796, -2.6584232147619, 1.378218295559888, -0.28197498175339497, -0.5389973392195522, -5.304106155169079, -1.9503419350996722, -0.4733994809474886, -5.606773618321855, -2.109972490445429, 3.173041549480562, 7.568158297689685, 0.9341922712859034, -2.0335123420166568, -9.269985087520213, 8.836019808463867, 4.686137671467488, -1.5173406474800615, 5.924600196994643, 3.619414402133982, -6.284484898516611, 1.8965408539423407, 7.378421858682501, -6.578883609210431, 4.590914408946167, -6.96467498182442, 2.105449592913679, -9.196658776632813, 2.935171074943801, 8.478216602599417, -1.0951766272795833, -8.334124804291703, 3.593083204489533, -6.657835310915758, -5.569209529942327, -9.596650356757756, -7.394717983866825, 7.9378544580582755, 3.784090493555169, -9.394259327330271, 0.01187386304137128, 6.42206488077958, 7.316305126689173, 0.11740011066576983, 0.3646290441852713, 5.068378350350976, -1.6000117793441309, -5.00179502523622, -2.911429048685001, 0.5893043592076381, 3.7601152255375307, -8.349090556175959, 0.7627856619201356, 0.5178195007014619, -0.805835082525741, 9.123172082230084, -3.2535595638440302, -5.884199208010092, -5.961437402432717, -8.699160771019546, -4.025122941134596, 3.0779153010229, -8.639034153253762, 8.117123538307467, 1.52021019128272, -5.020459007963547, 5.959527948284196, 0.6343437249976205, -7.967269052535215, -9.139448095269662, 3.0264736272496773, 6.9941524102828865, 1.5143771329289795, -0.5665745182084514, 9.705378256776008, -2.443353901013408, -2.2417371424569943, 0.423326701058091, 1.05269672533721, 6.229017006663099, 7.661436414881592, 5.194508853664992, -8.728361420562303, -0.1409048217250657, -3.3848293138393704, 1.4511150489153675, -3.4067415147228637, -3.4192509254728325, -5.632188963130062, 1.0593747233354023, 4.477300319272786, 9.985821668579021, 2.965139818159237, 0.8722680868992043, 0.4426056345579994, -8.964467362228648, 3.743997389339299, 8.320944681751136, 9.94965188451176, 2.4403038187096655, 0.8261633144259157, 1.8892358764513553, 8.310778302020427, -1.8394290988749908, -1.449857502624372, -3.652841857891329, -1.2953305680930107, 6.4106768433141, 7.255459260174241, -4.3495119530510795, 9.003811142180336, 0.5719790780886651, -2.8402997558910865, 3.414709080934921, 7.799434703643804, 1.3803438174202824, -9.402361541786878, -9.26508354271909, 9.286288092689034, -3.9292684491952574, 1.3336919109662055, 2.0183118892657284, -8.102967061383247, -3.605029904308548, -5.633490567773249, -2.896733128862725, -9.727717193364924, 5.893469845994261, 9.365569922765246, 0.5805042383823675, 9.40894899413641, 3.819435324096233, -5.008732738875203, -9.522249879468237, -9.924084367357759, 4.925033491140827, 8.144638083026493, 6.277810442050239, -8.656159350341063, 9.370167318857362, -4.4484878717511585, 2.730794588280963, 8.90379750337441, 9.47652699937947, -1.9817887709231048, -3.027946878437298, -9.25828843568995, -3.109590840485133, 0.7725520310019576, -9.454118914529799, -5.111335647880537, -1.6927630058732497, -9.550543519856491, 6.767317694415265, 1.5802471282832329, 9.295335992263464, 0.2369059567278402, -8.26927093114698, -4.46774299786208, 0.636490608069451, 8.305525675342771, 7.280296899010764, -6.409938669506515, -3.4417595849717824, 5.077266800866283, -4.222495107902939, 7.225490847110056, -2.813594135896526, 6.961609195042463, -4.470301120014524, 7.432624872222444, -3.1451101112703395, -9.453073083239845, -3.6034852788531673, -8.892143232132966, 4.8750808632659925, 7.181250643445821, -9.094977383686693, 2.8756459175146247, 3.4642197461807633, 2.92157383978366, 3.5644355351018326, 9.292909832188737, -6.7849153572533965, -8.33014980932533, -3.385009646174007, -2.8531792268759126, -8.880978679828766, 8.041289496932507, -8.098484669716422, 0.9305315174208406, 4.8782933953447145, -7.44113558157842, 7.89054745502585, 2.36916539945412, -0.22477979466682285, 0.9916610367784688, 7.645688665370372, -6.05954572693125, -0.5556711281748186, -4.607930162061031, -3.356272591950127, -4.127069392240594, 8.338014426870483, -2.441145096557376, -7.31080834626876, -8.975331385484504, -4.629510200280816, 9.931627452722445, 6.868121491643432, 7.986427472131712, 4.277098725516339, -5.050784369994452, -4.367853059137074, 4.375012486723058, 0.5125212518772297, -0.260844848106343, -0.0103310129978329, 9.968537412376545, 9.089613922677955, -5.135186108757079, 4.161957271180192, -1.8466071092172776, 5.28261238490199, -0.42784431234050224, 8.517987313096246, 4.849326232347986, 6.667591868674595, 7.885755961164698, -9.557980841151812, -9.449415774764411, 2.6872736314179875, -6.475911174986184, -6.322829333811855, -8.744155269259009, -7.6630808868123985, 5.730700696083925, -3.536637325927357, 1.9326725032011538, -2.937285199388519, -9.942192766279604, 1.4994802270363667, -1.0919822924346292, -7.146807319510757, 6.05517100781832, -9.993131372370968, -3.8470901140496245, -8.369082270259723, 0.7312579183444079, 7.75714726041441, 3.8008959632344492, -4.060245222408721, -0.27371509911184333, 0.5955897798125278, 5.94991328358134, -3.802041047671489, 0.37269344852454367, 7.068149403492107, -9.051855305170768, -9.04019188982522, 3.58496495616766};
  element_t top_diff_raw[] = {0.9605420224678962, -0.4424035607799859, -0.4758491338440063, 0.06789283732525808, 0.19162035294098967, 0.30690956484492027, -0.940936047281109, 0.2330264810867324, -0.3016190672143686, -0.49999632241666014, -0.9260381248879774, -0.655426698121168, 0.3861219893507599, 0.7132316445934401, 0.2790513100750276, 0.7314540755646044, -0.9389795070071631, -0.11231397032883805, -0.998696777101441, -0.5805895824420018, 0.7152729145384573, 0.43328525619797675, -0.664211865455189, -0.7825664056858019, -0.6226231338171733, 0.7257665448243393, 0.7246010725192578, -0.8775131958204172, 0.8804977722528609, -0.480576882856421, -0.8635935083961668, -0.5129793690997058, -0.6900441930380132, -0.13095916119689988, -0.13769723767728248, -0.6749799909693035, 0.4994933231079588, 0.7982032147186442, -0.06173537920119787, 0.6209870939404936, -0.6275483455400741, 0.8917797407556691, 0.9049734704548771, -0.31254348513273467, -0.8051725636549991, -0.823336616499482, 0.11498872926835979, -0.31287512282157115, 0.050658030194949966, -0.12197599715241281, -0.07349427521764174, 0.5837854024771634, -0.40470478549350597, -0.3036063596258627, 0.12931661539362205, -0.403846043946249, -0.6579572110315717, 0.15415979767612775, 0.5535716927052428, -0.3636228087719817, -0.033660031417017455, -0.8086298033669534, 0.27420778240142973, -0.4555660450484966, 0.10072239858430021, -0.6105314946174363, -0.8919475637136256, 0.24892523853876702, 0.2931925647215756, -0.32312905247789425, -0.4083936506409991, 0.5848149194580408, 0.8546596078273458, 0.4129263489794388, -0.17933100063302287, 0.19167765076414356, -0.8090961848765683, 0.43988030994660776, -0.5289207202662802, -0.7020223121417597, 0.9345281909973493, -0.9110093726544732, -0.20056186769904816, -0.2380210669815226, -0.5444897288468453, -0.05883528228564039, -0.9998567568569068, 0.3881185652952639, -0.23304746448048896, -0.8926999106293347, 0.8053618909409004, 0.9366583904130057, 0.11978040976155757, 0.17061725007560447, 0.7869585504602716, -0.13844559572477277, 0.061419166165267214, -0.2542625782598511, 0.5508464025794673, -0.6769208212574807, -0.7937162551770061, 0.31720779953879275, 0.9957292691957946, 0.3450045647378901, -0.3747671933809058, 0.7068237737737753, -0.8335251881627046, 0.5113491823483021, 0.24652288509112563, -0.9447322568994927, -0.7577175757886505, 0.6631422412305061, 0.25181161470317237, -0.8352692806066693, 0.10952923058084951, -0.1755139871870881, 0.7562468028545362, -0.9967850683202153, 0.11067475161835194, 0.18536550692970155, 0.49746815158819935, -0.5585688225854801, -0.32416773714443026, 0.5254147791882013, 0.8703880509675663, 0.053114827961885824, 0.20267762055979954, 0.4396392907953912, -0.3636570058143651, 0.46711888764610343, 0.5794108535722506, -0.9013497086985776, -0.9761074699917867, -0.5507946354554059, 0.7662577566397222, -0.46842124263937235, 0.558501320852669, 0.18791417241990027, -0.13299941870198384, 0.9546431391270762, 0.2536911220630662, -0.985573468729479, 0.9645898805871109, 0.8471287232672131, -0.30992765528455357, 0.9255296271546931, 0.408909308029755, -0.8175275408352287, 0.286434137448466, -0.6304386778047857, -0.7024566486300181, -0.7600046999721697, -0.4543977065577136, -0.22671628265183652, -0.9436588906961636, -0.7073248847286357, 0.7594354613172043, -0.9735049210226274, -0.37489242870467665, -0.14999428197843812, -0.7015857464583517, -0.9358079147589888, -0.12811063792835076, 0.9591986635791117, 0.5080789468622531, -0.8100877396536785, 0.8966716176806893, 0.11622085929102388, 0.9113345343375046, -0.11068872821622411, -0.17454348245320173, -0.24731132465504957, 0.6437288904782619, 0.6880140828709671, -0.7479202770880864, -0.6976801069852692, -0.7147498976590811, -0.04983088781825562, -0.8760541641058, -0.6245376519148145, -0.8333560894860677, -0.820820663925236, 0.7671411676655433, -0.755549667479188, -0.9065361750585321, -0.23742520585428872, 0.12512284871529955, -0.6814457891745571, 0.29676097822517966, -3.9241414275581477e-05, -0.4016551794607719, 0.5610256401224614, 0.6472969950566201, -0.6439231107637391, -0.30024707039247334, -0.1017277539035144, 0.4863249620465595, -0.7320549369412559, 0.0018357224610157097, 0.6984118870282814, 0.20008262679857736, 0.6892660306716014, -0.9026964636021966, -0.939271628282619, 0.2758140980719217, 0.15907590657935722, 0.7515773186283592, 0.7967363846808262, 0.31697875420933985, -0.6023264321460904, -0.6323953100724993, -0.8166626509341592, 0.36444595559000237, 0.13573276058546102, -0.002600913432136087, 0.29523610343466444, 0.7248882089358886, -0.3531164576527981, 0.9335310755889759, 0.8406457925952882, -0.9218464807360469, -0.5934512842137265, -0.6972478549694163, 0.7246618195337531, -0.17638503570150332, -0.9540555383965676, 0.7200475715256784, -0.4796959818685398, -0.5294121583774094, -0.05671101151782132, -0.3990738986185889, -0.9111967569182617, 0.13518716050257962, -0.8240754772306595, -0.9419255350708233, -0.047913243871074984, 0.2160731914052918, 0.6132057610123631, -0.1483252161201276, 0.19962989834879563, 0.6526343893985262, -0.8377169376092328, 0.03945193428795757, 0.27137889212789257, 0.1254944766988415, -0.11771942536833913, -0.13740686337107322, -0.5617675251685137, 0.7032288492162357, 0.3016023307491442, 0.42197761108254017, -0.053616332405617584, -0.3145510508749696, -0.2503780894118248, 0.2669926760177723, 0.5704371802330073, 0.19636321444910387, -0.4726987562736813, -0.24409857803712587, 0.3209578788465337, -0.2781242597283762, -0.731271758673744, -0.25742285693936906, -0.19484669042501412, -0.9487497099037259, 0.010501603004986926, 0.6366449293224656, -0.5531530109672302, -0.8153968729184686, -0.24072727422210471, 0.44127442597785604, 0.5289394518327108, 0.6732742001684444, 0.09167116721042223, 0.6164136997871228, 0.7466988414130609, 0.8702285480412169, -0.3711391335124672, -0.7152358089356634, 0.07060778034488058, 0.7076486005045513, 0.9152177676390709, 0.02010862154499593, -0.6176471433654322, -0.1912732947556457, 0.5987034646879414, -0.6248674687294185, 0.054391483184376366};
  element_t correct_raw[] = {0.202278,-0.413227,-0.354936,0.071175,0.254596,0.356969,-1.724079,0.179591,-0.388113,-0.508384,-0.719402,-0.127718,1.509782,0.807293,0.367445,0.780133,-0.690215,0.258549,-2.064074,-0.618952,0.647542,0.457253,-0.683379,-0.964728,-0.489620,0.706794,0.696435,-0.855779,1.153164,-0.856526,0.187029,-0.639243,-0.633383,-0.069273,-0.144940,-0.640437,0.224954,0.986641,-0.062080,0.631837,-0.347017,0.892069,0.132971,-0.164858,-0.768633,-0.856389,0.086035,-0.362570,-0.479465,0.007831,-0.071740,0.435145,-0.282618,0.041320,-0.142954,-0.435339,-0.652365,0.123451,0.520815,-0.246259,0.282251,-0.740648,0.269701,-0.551534,-0.015769,-0.667124,-1.625015,0.229210,-0.129213,-0.303816,-0.368752,0.587485,1.187934,0.372361,-0.181713,0.162206,-0.935678,0.266474,-0.517233,-0.958486,0.645372,-0.900399,-0.340318,-0.552895,-0.306767,-0.057752,-0.830961,0.345924,-0.155663,-0.645881,0.316628,0.696875,-0.161932,0.324314,0.715808,-0.716332,0.380281,-0.569850,0.086567,-0.694206,-0.767893,0.646621,0.716895,0.627483,0.243657,0.715455,-0.803748,-0.167367,0.016432,-0.983836,-1.107276,0.429284,0.273345,-0.760840,0.702415,-0.418515,0.514438,-0.984864,0.113967,0.197559,0.111359,-0.567602,0.339926,0.590072,0.856653,-0.435969,0.258963,0.567433,-0.001369,0.455220,0.585523,-0.652472,-1.010055,-0.645322,0.549096,-0.546950,0.624224,0.005295,-0.195747,1.119844,0.376505,-0.892382,0.978386,0.921298,-0.067223,0.649493,0.512349,-0.879007,0.319672,-0.584814,-0.828399,-0.885851,-0.227578,0.081806,-0.556477,-0.963406,0.640665,-1.077439,0.157766,-0.206288,-0.674507,-0.549898,-0.111665,0.948856,0.377883,-0.922624,0.481446,0.004754,0.924213,0.070609,-0.645871,-0.200864,0.205757,0.725859,-0.734392,-0.781631,-1.249132,-0.186027,-1.322717,-0.887940,-0.706032,-0.834026,0.122401,-0.635772,-0.579981,-0.147219,-0.043746,-0.529340,0.351145,-0.022709,-0.509622,0.807402,0.447389,-1.123785,-0.710080,-0.040411,0.671819,-0.739595,-0.115764,0.719099,-0.293165,0.729783,-0.888867,-0.833956,0.263457,-0.265715,0.680845,0.805208,0.423534,-0.645291,-0.463311,-0.851200,0.275533,0.114505,-0.014942,0.290754,0.512282,-0.150817,1.067474,0.862256,-0.983836,-0.696113,-0.885936,0.958729,0.002350,-0.797022,0.880901,-0.493118,-0.429155,0.038208,-0.262719,-0.641948,-0.123220,-0.995586,-1.007164,-0.161334,0.350017,0.984479,-0.041119,0.208860,0.758104,-0.946651,0.048261,0.517826,-0.152627,-0.345623,-0.157000,-0.673392,0.713654,-0.185120,0.038653,-0.340305,-0.310311,-0.197044,0.277388,0.875707,0.193633,-0.370059,-0.211812,0.256673,-0.249028,-1.155392,-0.257194,-0.041561,-1.073073,0.004722,0.676559,-0.154689,-0.813485,-0.605526,0.348250,0.459863,0.706522,-0.135280,0.632200,0.792827,0.881472,-0.284674,-0.698740,0.343666,0.662697,0.797101,0.014944,-0.649882,-0.180247,0.905142,-0.599106,0.118952};

  auto& ms = MinervaSystem::Instance();
  Scale bottom_size{2, 3, 24, 2};
  shared_ptr<element_t> bottom_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_diff_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  memcpy(bottom_ptr.get(), bottom_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_ptr.get(), top_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_diff_ptr.get(), top_diff_raw, bottom_size.Prod() * sizeof(element_t));
  ms.SetDevice(cpu_device);
  ImageBatch bottom = NArray::MakeNArray(bottom_size, bottom_ptr);
  ImageBatch top = NArray::MakeNArray(bottom_size, top_ptr);
  ImageBatch top_diff = NArray::MakeNArray(bottom_size, top_diff_ptr);
  ImageBatch scale = NArray::Ones(bottom_size);
  int local_size = 12;
  element_t alpha = 0.3;
  element_t beta = 0.75;
  ms.SetDevice(gpu_device);
  ImageBatch bottom_diff = Convolution::LRNBackward(bottom, top, scale, top_diff, local_size, alpha, beta);
  auto bottom_diff_ptr = bottom_diff.Get();
  for (int i = 0; i < bottom_size.Prod(); ++i) {
    EXPECT_NEAR(bottom_diff_ptr.get()[i], correct_raw[i], 0.001);
    //printf("%f,",bottom_diff_ptr.get()[i]);
  }
}


#endif


TEST(LRNBackward, CpuWithoutPaddingSmall) {
  element_t bottom_raw[] = {1,2,3,4,5,6,7,8};
  element_t top_raw[] = {.1,.2,.3,.4,.5,.6,.7,.8};
  element_t top_diff_raw[] = {8,6,4,2,0,-2,-4,-6};
  element_t correct_raw[] = {7.820000,5.460000,3.190000,1.280000,-0.900000,-2.000000,-1.480000,1.200000};
  Scale bottom_size{2, 2, 2, 1};

  auto& ms = MinervaSystem::Instance();
  shared_ptr<element_t> bottom_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_diff_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  memcpy(bottom_ptr.get(), bottom_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_ptr.get(), top_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_diff_ptr.get(), top_diff_raw, bottom_size.Prod() * sizeof(element_t));
  ms.SetDevice(cpu_device);
  ImageBatch bottom = NArray::MakeNArray(bottom_size, bottom_ptr);
  ImageBatch top = NArray::MakeNArray(bottom_size, top_ptr);
  ImageBatch top_diff = NArray::MakeNArray(bottom_size, top_diff_ptr);
  NArray scale = NArray::Ones(bottom_size);
  int local_size = 2;
  element_t alpha = 0.3;
  element_t beta = 0.75;
  ImageBatch bottom_diff = Convolution::LRNBackward(bottom, top, scale, top_diff, local_size, alpha, beta);
  auto bottom_diff_ptr = bottom_diff.Get();
  for (int i = 0; i < bottom_size.Prod(); ++i) {
    EXPECT_NEAR(bottom_diff_ptr.get()[i], correct_raw[i], 0.001);
    //printf("%f,",bottom_diff_ptr.get()[i]);
  }
}




TEST(LRNBackward, CpuLargeFracWide) {
  element_t bottom_raw[] = {8.59232186e-01, -3.67248891e-01, -6.32162377e-01, -5.90879443e-01, 1.35450058e-01, 1.91089406e-01, 9.29029039e-01, 3.06354194e-01, 4.97813275e-01, 3.07139742e-01, 4.95429619e-01, 9.22613472e-01, -9.83223404e-01, -7.87111247e-01, -4.02592572e-01, 3.12822366e-01, 6.19625105e-01, 7.44351827e-01, 9.29295195e-01, 4.47370694e-01, 2.84950656e-01, 4.34907242e-01, -6.48019856e-02, -3.48830645e-01, -1.20710788e-01, 4.59378165e-01, 9.88029172e-01, 3.53747424e-01, 5.81645036e-01, -6.58171484e-01, -9.46301448e-01, 6.00740488e-01, 8.07445076e-01, -9.50647579e-01, -1.65053631e-02, 5.25103347e-02, 1.92732021e-01, -8.96084910e-01, 7.90179056e-01, 4.56532361e-01, 6.36700023e-01, 4.45505669e-04, 6.20378818e-01, -8.08062949e-01, -5.62099913e-01, -4.82561877e-01, -6.37884921e-02, -8.12535948e-02, 4.19019560e-01, -6.43893988e-01, 6.28997687e-02, -6.64515542e-01, 5.37627837e-01, 8.56341098e-01, 2.18987316e-01, -6.99633011e-01, -2.07465926e-02, -2.45310092e-01, 6.97202824e-01, 8.22194457e-01, -2.32302558e-01, -3.69008193e-01, 1.36788306e-01, -6.24363930e-01, -7.48316912e-01, 3.75191610e-01, 5.99213436e-01, 1.47073130e-01, 9.46459963e-01, 2.68108754e-01, 7.76843450e-01, -9.17048249e-03, -2.96766940e-01, 4.28460737e-01, 7.85823290e-03, -5.48724787e-01, -5.10051120e-01, 5.85601400e-01, -9.65517098e-03, 8.30187347e-01, 8.90743668e-01, 6.64644593e-02, -4.95014811e-01, 4.41724116e-01, -2.65122472e-01, -2.70311418e-03, -5.46849905e-01, -2.92868707e-01, 3.01703573e-01, -3.74134209e-01, 5.37470894e-01, 5.63674207e-01, 7.04818966e-01, 8.99811480e-01, -7.85354176e-01, 8.21450712e-01, -3.27889676e-01, 6.52760854e-01, 7.96201270e-01, -9.14569391e-01, -6.08410002e-01, -4.10997356e-01, 2.53999761e-01, -8.27553790e-01, -7.14109960e-01, 3.16530385e-02, 3.78682659e-01, 7.13251622e-01, 2.94723367e-01, 1.63237351e-01, 4.22231910e-01, -4.95166286e-01, 8.00319367e-01, -1.15412614e-01, -9.58958351e-01, 9.19322028e-01, 3.04450845e-01, 2.64125002e-02, 3.64712766e-01, -2.09192187e-02, 8.52980343e-01, 3.17595443e-02, -8.55680237e-01, 1.35016596e-01, 2.30486367e-01, 8.83092589e-01, -1.69273291e-01, -4.71120051e-01, -8.05213669e-01, -2.83115562e-02, -7.06742743e-02, -9.40481366e-01, 3.88554924e-01, 4.33894225e-01, 4.59622847e-01, -1.71297966e-01, -9.69802310e-01, 8.17950315e-01, 5.78757436e-01, -6.69601662e-01, -3.74428077e-01, 2.21890612e-01, -2.71019427e-01, -6.87922822e-01, -6.45392373e-01, 7.35779342e-01, -4.19810663e-01, 1.70359243e-01, -9.20102482e-02, -1.77643736e-01, 7.65268890e-01, 3.85416030e-01, -4.41453290e-01, -8.71119538e-01, -6.02752772e-01, 8.63365489e-01, 7.08827136e-01, 9.09469469e-01, -8.95493304e-01, 1.58943361e-01, -3.90074667e-02, -9.56582042e-01, -2.52759073e-01, -1.71816398e-01, 2.07814468e-01, 3.43497455e-01, 6.77731401e-01, 5.59052417e-01, -1.98597912e-01, 5.89058463e-01, 7.86248621e-01, -4.75020618e-01, 9.78394015e-01, 7.06614198e-01, 4.62954312e-01, -2.88868751e-01, 7.66578981e-01, 7.35918182e-01, 9.11532892e-01, -9.99785487e-01, -9.66917916e-01, -3.71859885e-01, 9.90632349e-01, -7.02311554e-01, -6.65245763e-01, 5.17144074e-01, -8.60940668e-01, 4.10946877e-01, -6.16694364e-02, -9.79623568e-01, 5.49647726e-01, 5.88402017e-01, -7.00861097e-01, -9.52592736e-01, 5.24127542e-01, -5.52659640e-01, -4.75651204e-01, -8.62609944e-02, -5.00146163e-01, 1.36567123e-01, 6.93885994e-01, -2.43800926e-01, -1.35069767e-01, 6.65238353e-01, -2.57736129e-01, -9.18893456e-01, 1.09342972e-01, -9.75075144e-02, 4.50601953e-01, -2.43098955e-01, 6.81324991e-01, -6.13706128e-02, 1.25286858e-01, 3.22398678e-01, -7.55162650e-02, 2.47273891e-01, -5.56238738e-01, 4.65726234e-01, -2.36635823e-01, -6.10330916e-01, -4.57674450e-01, -5.01549896e-01, -6.95721875e-01, 5.42747408e-01, -4.89176535e-01, -7.44913190e-01, 3.30334307e-01, -1.74390103e-01, 3.35535533e-01, 3.19627034e-01, -3.89244656e-01, -5.97551518e-01, -5.55945747e-01, -7.60058273e-01, -9.25709118e-01, -9.31736833e-01, -5.39006904e-01, -5.43292587e-01, 2.49821244e-01, 7.85122371e-01, 5.59456032e-01, 4.42902537e-01, -3.79115682e-01, -2.73833167e-01, -6.07836432e-01, 8.70983596e-01, 1.23468000e-01, 6.34583074e-01, -3.02172038e-01, 5.99428526e-01, -7.91791075e-01, 4.24240330e-01, 8.34896992e-01, 6.07170737e-01, -3.45773707e-01, -4.89785641e-01, -9.99565129e-03, -1.72778091e-01, -1.50125809e-01, -8.51243390e-01, 2.06781303e-01, 4.94399467e-01, 5.95152453e-01, -2.36998955e-01, 5.94316306e-01, -5.64052608e-02, 4.42798342e-01, -6.21574621e-01, -1.30808581e-01, 6.46936218e-01, 6.52545256e-01, -6.20949033e-01, -9.59795660e-01, 4.06982772e-01, -3.05459761e-01, -1.60992368e-01, 5.36177806e-01, 9.25756133e-01, 7.85130614e-01, -7.30115467e-01, 5.95609430e-01, 3.64181215e-01, 6.01057742e-02, 7.31963310e-01, 5.06496191e-01, -8.13594826e-01, -3.41121136e-01, -1.75274609e-01};
  element_t top_raw[] = {9.508410415471417, -0.16577359468444186, 1.733487483269709, 9.348087491495974, -0.6363412119477747, 2.067057633053741, -4.1052398063235, -4.453070247027213, -9.817630059136809, -9.745100714613839, 8.507675533911446, 7.314343359317451, 9.805494998370659, 9.712134857051403, 2.745197189184328, -5.72670371128603, 8.54729452815252, -6.922344067868784, -3.432557259022766, 8.076599054245325, 7.980351773032467, 4.101995507376056, -8.887660144637092, 8.594494202367066, -4.945814105818405, 0.7834925569681879, -9.895184123041181, 3.650076839977796, -2.6584232147619, 1.378218295559888, -0.28197498175339497, -0.5389973392195522, -5.304106155169079, -1.9503419350996722, -0.4733994809474886, -5.606773618321855, -2.109972490445429, 3.173041549480562, 7.568158297689685, 0.9341922712859034, -2.0335123420166568, -9.269985087520213, 8.836019808463867, 4.686137671467488, -1.5173406474800615, 5.924600196994643, 3.619414402133982, -6.284484898516611, 1.8965408539423407, 7.378421858682501, -6.578883609210431, 4.590914408946167, -6.96467498182442, 2.105449592913679, -9.196658776632813, 2.935171074943801, 8.478216602599417, -1.0951766272795833, -8.334124804291703, 3.593083204489533, -6.657835310915758, -5.569209529942327, -9.596650356757756, -7.394717983866825, 7.9378544580582755, 3.784090493555169, -9.394259327330271, 0.01187386304137128, 6.42206488077958, 7.316305126689173, 0.11740011066576983, 0.3646290441852713, 5.068378350350976, -1.6000117793441309, -5.00179502523622, -2.911429048685001, 0.5893043592076381, 3.7601152255375307, -8.349090556175959, 0.7627856619201356, 0.5178195007014619, -0.805835082525741, 9.123172082230084, -3.2535595638440302, -5.884199208010092, -5.961437402432717, -8.699160771019546, -4.025122941134596, 3.0779153010229, -8.639034153253762, 8.117123538307467, 1.52021019128272, -5.020459007963547, 5.959527948284196, 0.6343437249976205, -7.967269052535215, -9.139448095269662, 3.0264736272496773, 6.9941524102828865, 1.5143771329289795, -0.5665745182084514, 9.705378256776008, -2.443353901013408, -2.2417371424569943, 0.423326701058091, 1.05269672533721, 6.229017006663099, 7.661436414881592, 5.194508853664992, -8.728361420562303, -0.1409048217250657, -3.3848293138393704, 1.4511150489153675, -3.4067415147228637, -3.4192509254728325, -5.632188963130062, 1.0593747233354023, 4.477300319272786, 9.985821668579021, 2.965139818159237, 0.8722680868992043, 0.4426056345579994, -8.964467362228648, 3.743997389339299, 8.320944681751136, 9.94965188451176, 2.4403038187096655, 0.8261633144259157, 1.8892358764513553, 8.310778302020427, -1.8394290988749908, -1.449857502624372, -3.652841857891329, -1.2953305680930107, 6.4106768433141, 7.255459260174241, -4.3495119530510795, 9.003811142180336, 0.5719790780886651, -2.8402997558910865, 3.414709080934921, 7.799434703643804, 1.3803438174202824, -9.402361541786878, -9.26508354271909, 9.286288092689034, -3.9292684491952574, 1.3336919109662055, 2.0183118892657284, -8.102967061383247, -3.605029904308548, -5.633490567773249, -2.896733128862725, -9.727717193364924, 5.893469845994261, 9.365569922765246, 0.5805042383823675, 9.40894899413641, 3.819435324096233, -5.008732738875203, -9.522249879468237, -9.924084367357759, 4.925033491140827, 8.144638083026493, 6.277810442050239, -8.656159350341063, 9.370167318857362, -4.4484878717511585, 2.730794588280963, 8.90379750337441, 9.47652699937947, -1.9817887709231048, -3.027946878437298, -9.25828843568995, -3.109590840485133, 0.7725520310019576, -9.454118914529799, -5.111335647880537, -1.6927630058732497, -9.550543519856491, 6.767317694415265, 1.5802471282832329, 9.295335992263464, 0.2369059567278402, -8.26927093114698, -4.46774299786208, 0.636490608069451, 8.305525675342771, 7.280296899010764, -6.409938669506515, -3.4417595849717824, 5.077266800866283, -4.222495107902939, 7.225490847110056, -2.813594135896526, 6.961609195042463, -4.470301120014524, 7.432624872222444, -3.1451101112703395, -9.453073083239845, -3.6034852788531673, -8.892143232132966, 4.8750808632659925, 7.181250643445821, -9.094977383686693, 2.8756459175146247, 3.4642197461807633, 2.92157383978366, 3.5644355351018326, 9.292909832188737, -6.7849153572533965, -8.33014980932533, -3.385009646174007, -2.8531792268759126, -8.880978679828766, 8.041289496932507, -8.098484669716422, 0.9305315174208406, 4.8782933953447145, -7.44113558157842, 7.89054745502585, 2.36916539945412, -0.22477979466682285, 0.9916610367784688, 7.645688665370372, -6.05954572693125, -0.5556711281748186, -4.607930162061031, -3.356272591950127, -4.127069392240594, 8.338014426870483, -2.441145096557376, -7.31080834626876, -8.975331385484504, -4.629510200280816, 9.931627452722445, 6.868121491643432, 7.986427472131712, 4.277098725516339, -5.050784369994452, -4.367853059137074, 4.375012486723058, 0.5125212518772297, -0.260844848106343, -0.0103310129978329, 9.968537412376545, 9.089613922677955, -5.135186108757079, 4.161957271180192, -1.8466071092172776, 5.28261238490199, -0.42784431234050224, 8.517987313096246, 4.849326232347986, 6.667591868674595, 7.885755961164698, -9.557980841151812, -9.449415774764411, 2.6872736314179875, -6.475911174986184, -6.322829333811855, -8.744155269259009, -7.6630808868123985, 5.730700696083925, -3.536637325927357, 1.9326725032011538, -2.937285199388519, -9.942192766279604, 1.4994802270363667, -1.0919822924346292, -7.146807319510757, 6.05517100781832, -9.993131372370968, -3.8470901140496245, -8.369082270259723, 0.7312579183444079, 7.75714726041441, 3.8008959632344492, -4.060245222408721, -0.27371509911184333, 0.5955897798125278, 5.94991328358134, -3.802041047671489, 0.37269344852454367, 7.068149403492107, -9.051855305170768, -9.04019188982522, 3.58496495616766};
  element_t top_diff_raw[] = {0.9605420224678962, -0.4424035607799859, -0.4758491338440063, 0.06789283732525808, 0.19162035294098967, 0.30690956484492027, -0.940936047281109, 0.2330264810867324, -0.3016190672143686, -0.49999632241666014, -0.9260381248879774, -0.655426698121168, 0.3861219893507599, 0.7132316445934401, 0.2790513100750276, 0.7314540755646044, -0.9389795070071631, -0.11231397032883805, -0.998696777101441, -0.5805895824420018, 0.7152729145384573, 0.43328525619797675, -0.664211865455189, -0.7825664056858019, -0.6226231338171733, 0.7257665448243393, 0.7246010725192578, -0.8775131958204172, 0.8804977722528609, -0.480576882856421, -0.8635935083961668, -0.5129793690997058, -0.6900441930380132, -0.13095916119689988, -0.13769723767728248, -0.6749799909693035, 0.4994933231079588, 0.7982032147186442, -0.06173537920119787, 0.6209870939404936, -0.6275483455400741, 0.8917797407556691, 0.9049734704548771, -0.31254348513273467, -0.8051725636549991, -0.823336616499482, 0.11498872926835979, -0.31287512282157115, 0.050658030194949966, -0.12197599715241281, -0.07349427521764174, 0.5837854024771634, -0.40470478549350597, -0.3036063596258627, 0.12931661539362205, -0.403846043946249, -0.6579572110315717, 0.15415979767612775, 0.5535716927052428, -0.3636228087719817, -0.033660031417017455, -0.8086298033669534, 0.27420778240142973, -0.4555660450484966, 0.10072239858430021, -0.6105314946174363, -0.8919475637136256, 0.24892523853876702, 0.2931925647215756, -0.32312905247789425, -0.4083936506409991, 0.5848149194580408, 0.8546596078273458, 0.4129263489794388, -0.17933100063302287, 0.19167765076414356, -0.8090961848765683, 0.43988030994660776, -0.5289207202662802, -0.7020223121417597, 0.9345281909973493, -0.9110093726544732, -0.20056186769904816, -0.2380210669815226, -0.5444897288468453, -0.05883528228564039, -0.9998567568569068, 0.3881185652952639, -0.23304746448048896, -0.8926999106293347, 0.8053618909409004, 0.9366583904130057, 0.11978040976155757, 0.17061725007560447, 0.7869585504602716, -0.13844559572477277, 0.061419166165267214, -0.2542625782598511, 0.5508464025794673, -0.6769208212574807, -0.7937162551770061, 0.31720779953879275, 0.9957292691957946, 0.3450045647378901, -0.3747671933809058, 0.7068237737737753, -0.8335251881627046, 0.5113491823483021, 0.24652288509112563, -0.9447322568994927, -0.7577175757886505, 0.6631422412305061, 0.25181161470317237, -0.8352692806066693, 0.10952923058084951, -0.1755139871870881, 0.7562468028545362, -0.9967850683202153, 0.11067475161835194, 0.18536550692970155, 0.49746815158819935, -0.5585688225854801, -0.32416773714443026, 0.5254147791882013, 0.8703880509675663, 0.053114827961885824, 0.20267762055979954, 0.4396392907953912, -0.3636570058143651, 0.46711888764610343, 0.5794108535722506, -0.9013497086985776, -0.9761074699917867, -0.5507946354554059, 0.7662577566397222, -0.46842124263937235, 0.558501320852669, 0.18791417241990027, -0.13299941870198384, 0.9546431391270762, 0.2536911220630662, -0.985573468729479, 0.9645898805871109, 0.8471287232672131, -0.30992765528455357, 0.9255296271546931, 0.408909308029755, -0.8175275408352287, 0.286434137448466, -0.6304386778047857, -0.7024566486300181, -0.7600046999721697, -0.4543977065577136, -0.22671628265183652, -0.9436588906961636, -0.7073248847286357, 0.7594354613172043, -0.9735049210226274, -0.37489242870467665, -0.14999428197843812, -0.7015857464583517, -0.9358079147589888, -0.12811063792835076, 0.9591986635791117, 0.5080789468622531, -0.8100877396536785, 0.8966716176806893, 0.11622085929102388, 0.9113345343375046, -0.11068872821622411, -0.17454348245320173, -0.24731132465504957, 0.6437288904782619, 0.6880140828709671, -0.7479202770880864, -0.6976801069852692, -0.7147498976590811, -0.04983088781825562, -0.8760541641058, -0.6245376519148145, -0.8333560894860677, -0.820820663925236, 0.7671411676655433, -0.755549667479188, -0.9065361750585321, -0.23742520585428872, 0.12512284871529955, -0.6814457891745571, 0.29676097822517966, -3.9241414275581477e-05, -0.4016551794607719, 0.5610256401224614, 0.6472969950566201, -0.6439231107637391, -0.30024707039247334, -0.1017277539035144, 0.4863249620465595, -0.7320549369412559, 0.0018357224610157097, 0.6984118870282814, 0.20008262679857736, 0.6892660306716014, -0.9026964636021966, -0.939271628282619, 0.2758140980719217, 0.15907590657935722, 0.7515773186283592, 0.7967363846808262, 0.31697875420933985, -0.6023264321460904, -0.6323953100724993, -0.8166626509341592, 0.36444595559000237, 0.13573276058546102, -0.002600913432136087, 0.29523610343466444, 0.7248882089358886, -0.3531164576527981, 0.9335310755889759, 0.8406457925952882, -0.9218464807360469, -0.5934512842137265, -0.6972478549694163, 0.7246618195337531, -0.17638503570150332, -0.9540555383965676, 0.7200475715256784, -0.4796959818685398, -0.5294121583774094, -0.05671101151782132, -0.3990738986185889, -0.9111967569182617, 0.13518716050257962, -0.8240754772306595, -0.9419255350708233, -0.047913243871074984, 0.2160731914052918, 0.6132057610123631, -0.1483252161201276, 0.19962989834879563, 0.6526343893985262, -0.8377169376092328, 0.03945193428795757, 0.27137889212789257, 0.1254944766988415, -0.11771942536833913, -0.13740686337107322, -0.5617675251685137, 0.7032288492162357, 0.3016023307491442, 0.42197761108254017, -0.053616332405617584, -0.3145510508749696, -0.2503780894118248, 0.2669926760177723, 0.5704371802330073, 0.19636321444910387, -0.4726987562736813, -0.24409857803712587, 0.3209578788465337, -0.2781242597283762, -0.731271758673744, -0.25742285693936906, -0.19484669042501412, -0.9487497099037259, 0.010501603004986926, 0.6366449293224656, -0.5531530109672302, -0.8153968729184686, -0.24072727422210471, 0.44127442597785604, 0.5289394518327108, 0.6732742001684444, 0.09167116721042223, 0.6164136997871228, 0.7466988414130609, 0.8702285480412169, -0.3711391335124672, -0.7152358089356634, 0.07060778034488058, 0.7076486005045513, 0.9152177676390709, 0.02010862154499593, -0.6176471433654322, -0.1912732947556457, 0.5987034646879414, -0.6248674687294185, 0.054391483184376366};
  element_t correct_raw[] = {-0.805160,-0.436343,-0.593177,0.152271,0.195337,0.279633,-1.748376,0.304554,-0.633295,-0.836718,-0.047816,0.339754,1.223707,1.940004,0.348443,1.026284,0.179934,-0.242525,-1.715480,-0.108583,0.349302,0.259366,-0.578139,-1.310451,-0.538987,0.666993,2.318553,-0.622577,1.186830,-0.578662,-0.811746,-0.550352,-1.354987,-0.076327,-0.137455,-0.719693,0.545196,1.308850,0.021332,0.561397,-0.810363,0.892608,-0.211201,-0.578833,-0.650658,-1.352966,0.120962,-0.276928,-0.819475,-0.241738,-0.068663,1.079398,-0.730915,-0.302676,-0.002412,-0.753791,-0.670174,0.413778,2.513195,0.764940,0.175946,0.140403,0.331621,-0.570767,-1.115965,-0.481133,-2.483840,0.404000,-1.323344,-0.287732,-1.431848,0.571377,1.349519,0.421801,-0.168240,-0.272673,-1.132441,0.309219,-0.518798,-0.653644,0.104002,-0.925807,-0.397097,-0.691118,-0.416239,-0.057082,0.012858,0.323402,-0.270983,-0.939396,-0.952198,0.941821,0.021400,0.952335,0.948713,-0.705732,0.027094,-0.009060,-0.225966,-0.336359,-0.346306,0.542789,1.202738,-0.019717,-1.296551,0.702727,0.001945,0.092309,0.146744,-1.412997,-0.517865,0.788388,0.042041,-0.821370,1.836664,-0.380600,0.572385,-0.956213,0.023918,0.188956,-0.417161,-0.552081,0.408010,0.482608,0.519525,-0.380534,0.389705,0.421377,-0.400456,0.496525,0.533367,-0.460941,-1.567926,-0.654689,-0.641237,-0.659622,-0.128084,-1.542789,-0.974373,0.760660,0.276010,-0.652565,1.076223,-0.214986,0.107053,-0.497332,0.257143,-0.775734,0.298402,-0.426256,-1.138495,-1.131289,-0.323657,0.205553,-1.697896,0.579532,0.689125,0.900842,-0.663396,-0.176862,-0.642952,1.063050,-0.163993,1.261213,0.358938,-1.352043,-0.384540,0.181254,1.022539,0.019934,0.118071,-0.194928,1.072818,1.700742,-0.990179,-0.732712,-1.880256,-0.092005,-1.180200,0.717226,-2.060285,-0.929347,-0.822267,-0.783834,0.215526,-0.360852,0.140550,-0.158127,0.326739,0.000016,-0.572618,0.183914,0.669106,0.200995,-0.210392,-0.325371,0.315529,-0.738512,0.286162,0.769720,0.107146,0.474035,-1.205453,1.061879,0.155909,-1.640115,0.722750,0.864287,-0.474895,-0.400512,-1.193436,-0.614850,0.309308,-0.344841,0.140551,0.191915,0.301640,-0.215410,1.087934,0.048937,-1.871606,-1.470942,-0.308651,0.702726,0.418927,0.057585,0.639565,-0.158924,-0.237793,0.019739,-0.065976,-0.636199,0.949267,0.622201,-0.017081,-1.334190,0.658069,1.211890,-0.190370,-0.125444,1.355512,-0.008834,0.113237,0.223384,-0.172009,1.178549,-0.102550,-0.030999,0.853199,1.203352,0.035105,0.588046,0.659999,-0.147000,0.608050,1.322680,0.194683,-0.516652,-0.121322,1.225826,-0.302545,-1.399499,-0.524673,-0.127792,-0.612426,0.006589,0.369236,-0.658856,-1.065467,-0.074335,0.881298,1.076817,-1.070922,-0.405421,0.234357,0.846546,-0.158510,-0.126057,-0.640431,0.432842,0.783615,-0.137051,-0.037830,-0.501367,-0.206324,0.503137,-0.239992,0.022318};

  auto& ms = MinervaSystem::Instance();
  Scale bottom_size{8, 6, 3, 2};
  shared_ptr<element_t> bottom_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_diff_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  memcpy(bottom_ptr.get(), bottom_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_ptr.get(), top_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_diff_ptr.get(), top_diff_raw, bottom_size.Prod() * sizeof(element_t));
  ms.SetDevice(cpu_device);
  ImageBatch bottom = NArray::MakeNArray(bottom_size, bottom_ptr);
  ImageBatch top = NArray::MakeNArray(bottom_size, top_ptr);
  ImageBatch top_diff = NArray::MakeNArray(bottom_size, top_diff_ptr);
  ImageBatch scale = NArray::Ones(bottom_size);
  int local_size = 2;
  element_t alpha = 0.3;
  element_t beta = 0.75;
  ImageBatch bottom_diff = Convolution::LRNBackward(bottom, top, scale, top_diff, local_size, alpha, beta);
  auto bottom_diff_ptr = bottom_diff.Get();
  for (int i = 0; i < bottom_size.Prod(); ++i) {
    EXPECT_NEAR(bottom_diff_ptr.get()[i], correct_raw[i], 0.001);
    //printf("%f,",bottom_diff_ptr.get()[i]);
  }
}


TEST(LRNBackward, CpuLargeFracLong) {
  element_t bottom_raw[] = {8.59232186e-01, -3.67248891e-01, -6.32162377e-01, -5.90879443e-01, 1.35450058e-01, 1.91089406e-01, 9.29029039e-01, 3.06354194e-01, 4.97813275e-01, 3.07139742e-01, 4.95429619e-01, 9.22613472e-01, -9.83223404e-01, -7.87111247e-01, -4.02592572e-01, 3.12822366e-01, 6.19625105e-01, 7.44351827e-01, 9.29295195e-01, 4.47370694e-01, 2.84950656e-01, 4.34907242e-01, -6.48019856e-02, -3.48830645e-01, -1.20710788e-01, 4.59378165e-01, 9.88029172e-01, 3.53747424e-01, 5.81645036e-01, -6.58171484e-01, -9.46301448e-01, 6.00740488e-01, 8.07445076e-01, -9.50647579e-01, -1.65053631e-02, 5.25103347e-02, 1.92732021e-01, -8.96084910e-01, 7.90179056e-01, 4.56532361e-01, 6.36700023e-01, 4.45505669e-04, 6.20378818e-01, -8.08062949e-01, -5.62099913e-01, -4.82561877e-01, -6.37884921e-02, -8.12535948e-02, 4.19019560e-01, -6.43893988e-01, 6.28997687e-02, -6.64515542e-01, 5.37627837e-01, 8.56341098e-01, 2.18987316e-01, -6.99633011e-01, -2.07465926e-02, -2.45310092e-01, 6.97202824e-01, 8.22194457e-01, -2.32302558e-01, -3.69008193e-01, 1.36788306e-01, -6.24363930e-01, -7.48316912e-01, 3.75191610e-01, 5.99213436e-01, 1.47073130e-01, 9.46459963e-01, 2.68108754e-01, 7.76843450e-01, -9.17048249e-03, -2.96766940e-01, 4.28460737e-01, 7.85823290e-03, -5.48724787e-01, -5.10051120e-01, 5.85601400e-01, -9.65517098e-03, 8.30187347e-01, 8.90743668e-01, 6.64644593e-02, -4.95014811e-01, 4.41724116e-01, -2.65122472e-01, -2.70311418e-03, -5.46849905e-01, -2.92868707e-01, 3.01703573e-01, -3.74134209e-01, 5.37470894e-01, 5.63674207e-01, 7.04818966e-01, 8.99811480e-01, -7.85354176e-01, 8.21450712e-01, -3.27889676e-01, 6.52760854e-01, 7.96201270e-01, -9.14569391e-01, -6.08410002e-01, -4.10997356e-01, 2.53999761e-01, -8.27553790e-01, -7.14109960e-01, 3.16530385e-02, 3.78682659e-01, 7.13251622e-01, 2.94723367e-01, 1.63237351e-01, 4.22231910e-01, -4.95166286e-01, 8.00319367e-01, -1.15412614e-01, -9.58958351e-01, 9.19322028e-01, 3.04450845e-01, 2.64125002e-02, 3.64712766e-01, -2.09192187e-02, 8.52980343e-01, 3.17595443e-02, -8.55680237e-01, 1.35016596e-01, 2.30486367e-01, 8.83092589e-01, -1.69273291e-01, -4.71120051e-01, -8.05213669e-01, -2.83115562e-02, -7.06742743e-02, -9.40481366e-01, 3.88554924e-01, 4.33894225e-01, 4.59622847e-01, -1.71297966e-01, -9.69802310e-01, 8.17950315e-01, 5.78757436e-01, -6.69601662e-01, -3.74428077e-01, 2.21890612e-01, -2.71019427e-01, -6.87922822e-01, -6.45392373e-01, 7.35779342e-01, -4.19810663e-01, 1.70359243e-01, -9.20102482e-02, -1.77643736e-01, 7.65268890e-01, 3.85416030e-01, -4.41453290e-01, -8.71119538e-01, -6.02752772e-01, 8.63365489e-01, 7.08827136e-01, 9.09469469e-01, -8.95493304e-01, 1.58943361e-01, -3.90074667e-02, -9.56582042e-01, -2.52759073e-01, -1.71816398e-01, 2.07814468e-01, 3.43497455e-01, 6.77731401e-01, 5.59052417e-01, -1.98597912e-01, 5.89058463e-01, 7.86248621e-01, -4.75020618e-01, 9.78394015e-01, 7.06614198e-01, 4.62954312e-01, -2.88868751e-01, 7.66578981e-01, 7.35918182e-01, 9.11532892e-01, -9.99785487e-01, -9.66917916e-01, -3.71859885e-01, 9.90632349e-01, -7.02311554e-01, -6.65245763e-01, 5.17144074e-01, -8.60940668e-01, 4.10946877e-01, -6.16694364e-02, -9.79623568e-01, 5.49647726e-01, 5.88402017e-01, -7.00861097e-01, -9.52592736e-01, 5.24127542e-01, -5.52659640e-01, -4.75651204e-01, -8.62609944e-02, -5.00146163e-01, 1.36567123e-01, 6.93885994e-01, -2.43800926e-01, -1.35069767e-01, 6.65238353e-01, -2.57736129e-01, -9.18893456e-01, 1.09342972e-01, -9.75075144e-02, 4.50601953e-01, -2.43098955e-01, 6.81324991e-01, -6.13706128e-02, 1.25286858e-01, 3.22398678e-01, -7.55162650e-02, 2.47273891e-01, -5.56238738e-01, 4.65726234e-01, -2.36635823e-01, -6.10330916e-01, -4.57674450e-01, -5.01549896e-01, -6.95721875e-01, 5.42747408e-01, -4.89176535e-01, -7.44913190e-01, 3.30334307e-01, -1.74390103e-01, 3.35535533e-01, 3.19627034e-01, -3.89244656e-01, -5.97551518e-01, -5.55945747e-01, -7.60058273e-01, -9.25709118e-01, -9.31736833e-01, -5.39006904e-01, -5.43292587e-01, 2.49821244e-01, 7.85122371e-01, 5.59456032e-01, 4.42902537e-01, -3.79115682e-01, -2.73833167e-01, -6.07836432e-01, 8.70983596e-01, 1.23468000e-01, 6.34583074e-01, -3.02172038e-01, 5.99428526e-01, -7.91791075e-01, 4.24240330e-01, 8.34896992e-01, 6.07170737e-01, -3.45773707e-01, -4.89785641e-01, -9.99565129e-03, -1.72778091e-01, -1.50125809e-01, -8.51243390e-01, 2.06781303e-01, 4.94399467e-01, 5.95152453e-01, -2.36998955e-01, 5.94316306e-01, -5.64052608e-02, 4.42798342e-01, -6.21574621e-01, -1.30808581e-01, 6.46936218e-01, 6.52545256e-01, -6.20949033e-01, -9.59795660e-01, 4.06982772e-01, -3.05459761e-01, -1.60992368e-01, 5.36177806e-01, 9.25756133e-01, 7.85130614e-01, -7.30115467e-01, 5.95609430e-01, 3.64181215e-01, 6.01057742e-02, 7.31963310e-01, 5.06496191e-01, -8.13594826e-01, -3.41121136e-01, -1.75274609e-01};
  element_t top_raw[] = {9.508410415471417, -0.16577359468444186, 1.733487483269709, 9.348087491495974, -0.6363412119477747, 2.067057633053741, -4.1052398063235, -4.453070247027213, -9.817630059136809, -9.745100714613839, 8.507675533911446, 7.314343359317451, 9.805494998370659, 9.712134857051403, 2.745197189184328, -5.72670371128603, 8.54729452815252, -6.922344067868784, -3.432557259022766, 8.076599054245325, 7.980351773032467, 4.101995507376056, -8.887660144637092, 8.594494202367066, -4.945814105818405, 0.7834925569681879, -9.895184123041181, 3.650076839977796, -2.6584232147619, 1.378218295559888, -0.28197498175339497, -0.5389973392195522, -5.304106155169079, -1.9503419350996722, -0.4733994809474886, -5.606773618321855, -2.109972490445429, 3.173041549480562, 7.568158297689685, 0.9341922712859034, -2.0335123420166568, -9.269985087520213, 8.836019808463867, 4.686137671467488, -1.5173406474800615, 5.924600196994643, 3.619414402133982, -6.284484898516611, 1.8965408539423407, 7.378421858682501, -6.578883609210431, 4.590914408946167, -6.96467498182442, 2.105449592913679, -9.196658776632813, 2.935171074943801, 8.478216602599417, -1.0951766272795833, -8.334124804291703, 3.593083204489533, -6.657835310915758, -5.569209529942327, -9.596650356757756, -7.394717983866825, 7.9378544580582755, 3.784090493555169, -9.394259327330271, 0.01187386304137128, 6.42206488077958, 7.316305126689173, 0.11740011066576983, 0.3646290441852713, 5.068378350350976, -1.6000117793441309, -5.00179502523622, -2.911429048685001, 0.5893043592076381, 3.7601152255375307, -8.349090556175959, 0.7627856619201356, 0.5178195007014619, -0.805835082525741, 9.123172082230084, -3.2535595638440302, -5.884199208010092, -5.961437402432717, -8.699160771019546, -4.025122941134596, 3.0779153010229, -8.639034153253762, 8.117123538307467, 1.52021019128272, -5.020459007963547, 5.959527948284196, 0.6343437249976205, -7.967269052535215, -9.139448095269662, 3.0264736272496773, 6.9941524102828865, 1.5143771329289795, -0.5665745182084514, 9.705378256776008, -2.443353901013408, -2.2417371424569943, 0.423326701058091, 1.05269672533721, 6.229017006663099, 7.661436414881592, 5.194508853664992, -8.728361420562303, -0.1409048217250657, -3.3848293138393704, 1.4511150489153675, -3.4067415147228637, -3.4192509254728325, -5.632188963130062, 1.0593747233354023, 4.477300319272786, 9.985821668579021, 2.965139818159237, 0.8722680868992043, 0.4426056345579994, -8.964467362228648, 3.743997389339299, 8.320944681751136, 9.94965188451176, 2.4403038187096655, 0.8261633144259157, 1.8892358764513553, 8.310778302020427, -1.8394290988749908, -1.449857502624372, -3.652841857891329, -1.2953305680930107, 6.4106768433141, 7.255459260174241, -4.3495119530510795, 9.003811142180336, 0.5719790780886651, -2.8402997558910865, 3.414709080934921, 7.799434703643804, 1.3803438174202824, -9.402361541786878, -9.26508354271909, 9.286288092689034, -3.9292684491952574, 1.3336919109662055, 2.0183118892657284, -8.102967061383247, -3.605029904308548, -5.633490567773249, -2.896733128862725, -9.727717193364924, 5.893469845994261, 9.365569922765246, 0.5805042383823675, 9.40894899413641, 3.819435324096233, -5.008732738875203, -9.522249879468237, -9.924084367357759, 4.925033491140827, 8.144638083026493, 6.277810442050239, -8.656159350341063, 9.370167318857362, -4.4484878717511585, 2.730794588280963, 8.90379750337441, 9.47652699937947, -1.9817887709231048, -3.027946878437298, -9.25828843568995, -3.109590840485133, 0.7725520310019576, -9.454118914529799, -5.111335647880537, -1.6927630058732497, -9.550543519856491, 6.767317694415265, 1.5802471282832329, 9.295335992263464, 0.2369059567278402, -8.26927093114698, -4.46774299786208, 0.636490608069451, 8.305525675342771, 7.280296899010764, -6.409938669506515, -3.4417595849717824, 5.077266800866283, -4.222495107902939, 7.225490847110056, -2.813594135896526, 6.961609195042463, -4.470301120014524, 7.432624872222444, -3.1451101112703395, -9.453073083239845, -3.6034852788531673, -8.892143232132966, 4.8750808632659925, 7.181250643445821, -9.094977383686693, 2.8756459175146247, 3.4642197461807633, 2.92157383978366, 3.5644355351018326, 9.292909832188737, -6.7849153572533965, -8.33014980932533, -3.385009646174007, -2.8531792268759126, -8.880978679828766, 8.041289496932507, -8.098484669716422, 0.9305315174208406, 4.8782933953447145, -7.44113558157842, 7.89054745502585, 2.36916539945412, -0.22477979466682285, 0.9916610367784688, 7.645688665370372, -6.05954572693125, -0.5556711281748186, -4.607930162061031, -3.356272591950127, -4.127069392240594, 8.338014426870483, -2.441145096557376, -7.31080834626876, -8.975331385484504, -4.629510200280816, 9.931627452722445, 6.868121491643432, 7.986427472131712, 4.277098725516339, -5.050784369994452, -4.367853059137074, 4.375012486723058, 0.5125212518772297, -0.260844848106343, -0.0103310129978329, 9.968537412376545, 9.089613922677955, -5.135186108757079, 4.161957271180192, -1.8466071092172776, 5.28261238490199, -0.42784431234050224, 8.517987313096246, 4.849326232347986, 6.667591868674595, 7.885755961164698, -9.557980841151812, -9.449415774764411, 2.6872736314179875, -6.475911174986184, -6.322829333811855, -8.744155269259009, -7.6630808868123985, 5.730700696083925, -3.536637325927357, 1.9326725032011538, -2.937285199388519, -9.942192766279604, 1.4994802270363667, -1.0919822924346292, -7.146807319510757, 6.05517100781832, -9.993131372370968, -3.8470901140496245, -8.369082270259723, 0.7312579183444079, 7.75714726041441, 3.8008959632344492, -4.060245222408721, -0.27371509911184333, 0.5955897798125278, 5.94991328358134, -3.802041047671489, 0.37269344852454367, 7.068149403492107, -9.051855305170768, -9.04019188982522, 3.58496495616766};
  element_t top_diff_raw[] = {0.9605420224678962, -0.4424035607799859, -0.4758491338440063, 0.06789283732525808, 0.19162035294098967, 0.30690956484492027, -0.940936047281109, 0.2330264810867324, -0.3016190672143686, -0.49999632241666014, -0.9260381248879774, -0.655426698121168, 0.3861219893507599, 0.7132316445934401, 0.2790513100750276, 0.7314540755646044, -0.9389795070071631, -0.11231397032883805, -0.998696777101441, -0.5805895824420018, 0.7152729145384573, 0.43328525619797675, -0.664211865455189, -0.7825664056858019, -0.6226231338171733, 0.7257665448243393, 0.7246010725192578, -0.8775131958204172, 0.8804977722528609, -0.480576882856421, -0.8635935083961668, -0.5129793690997058, -0.6900441930380132, -0.13095916119689988, -0.13769723767728248, -0.6749799909693035, 0.4994933231079588, 0.7982032147186442, -0.06173537920119787, 0.6209870939404936, -0.6275483455400741, 0.8917797407556691, 0.9049734704548771, -0.31254348513273467, -0.8051725636549991, -0.823336616499482, 0.11498872926835979, -0.31287512282157115, 0.050658030194949966, -0.12197599715241281, -0.07349427521764174, 0.5837854024771634, -0.40470478549350597, -0.3036063596258627, 0.12931661539362205, -0.403846043946249, -0.6579572110315717, 0.15415979767612775, 0.5535716927052428, -0.3636228087719817, -0.033660031417017455, -0.8086298033669534, 0.27420778240142973, -0.4555660450484966, 0.10072239858430021, -0.6105314946174363, -0.8919475637136256, 0.24892523853876702, 0.2931925647215756, -0.32312905247789425, -0.4083936506409991, 0.5848149194580408, 0.8546596078273458, 0.4129263489794388, -0.17933100063302287, 0.19167765076414356, -0.8090961848765683, 0.43988030994660776, -0.5289207202662802, -0.7020223121417597, 0.9345281909973493, -0.9110093726544732, -0.20056186769904816, -0.2380210669815226, -0.5444897288468453, -0.05883528228564039, -0.9998567568569068, 0.3881185652952639, -0.23304746448048896, -0.8926999106293347, 0.8053618909409004, 0.9366583904130057, 0.11978040976155757, 0.17061725007560447, 0.7869585504602716, -0.13844559572477277, 0.061419166165267214, -0.2542625782598511, 0.5508464025794673, -0.6769208212574807, -0.7937162551770061, 0.31720779953879275, 0.9957292691957946, 0.3450045647378901, -0.3747671933809058, 0.7068237737737753, -0.8335251881627046, 0.5113491823483021, 0.24652288509112563, -0.9447322568994927, -0.7577175757886505, 0.6631422412305061, 0.25181161470317237, -0.8352692806066693, 0.10952923058084951, -0.1755139871870881, 0.7562468028545362, -0.9967850683202153, 0.11067475161835194, 0.18536550692970155, 0.49746815158819935, -0.5585688225854801, -0.32416773714443026, 0.5254147791882013, 0.8703880509675663, 0.053114827961885824, 0.20267762055979954, 0.4396392907953912, -0.3636570058143651, 0.46711888764610343, 0.5794108535722506, -0.9013497086985776, -0.9761074699917867, -0.5507946354554059, 0.7662577566397222, -0.46842124263937235, 0.558501320852669, 0.18791417241990027, -0.13299941870198384, 0.9546431391270762, 0.2536911220630662, -0.985573468729479, 0.9645898805871109, 0.8471287232672131, -0.30992765528455357, 0.9255296271546931, 0.408909308029755, -0.8175275408352287, 0.286434137448466, -0.6304386778047857, -0.7024566486300181, -0.7600046999721697, -0.4543977065577136, -0.22671628265183652, -0.9436588906961636, -0.7073248847286357, 0.7594354613172043, -0.9735049210226274, -0.37489242870467665, -0.14999428197843812, -0.7015857464583517, -0.9358079147589888, -0.12811063792835076, 0.9591986635791117, 0.5080789468622531, -0.8100877396536785, 0.8966716176806893, 0.11622085929102388, 0.9113345343375046, -0.11068872821622411, -0.17454348245320173, -0.24731132465504957, 0.6437288904782619, 0.6880140828709671, -0.7479202770880864, -0.6976801069852692, -0.7147498976590811, -0.04983088781825562, -0.8760541641058, -0.6245376519148145, -0.8333560894860677, -0.820820663925236, 0.7671411676655433, -0.755549667479188, -0.9065361750585321, -0.23742520585428872, 0.12512284871529955, -0.6814457891745571, 0.29676097822517966, -3.9241414275581477e-05, -0.4016551794607719, 0.5610256401224614, 0.6472969950566201, -0.6439231107637391, -0.30024707039247334, -0.1017277539035144, 0.4863249620465595, -0.7320549369412559, 0.0018357224610157097, 0.6984118870282814, 0.20008262679857736, 0.6892660306716014, -0.9026964636021966, -0.939271628282619, 0.2758140980719217, 0.15907590657935722, 0.7515773186283592, 0.7967363846808262, 0.31697875420933985, -0.6023264321460904, -0.6323953100724993, -0.8166626509341592, 0.36444595559000237, 0.13573276058546102, -0.002600913432136087, 0.29523610343466444, 0.7248882089358886, -0.3531164576527981, 0.9335310755889759, 0.8406457925952882, -0.9218464807360469, -0.5934512842137265, -0.6972478549694163, 0.7246618195337531, -0.17638503570150332, -0.9540555383965676, 0.7200475715256784, -0.4796959818685398, -0.5294121583774094, -0.05671101151782132, -0.3990738986185889, -0.9111967569182617, 0.13518716050257962, -0.8240754772306595, -0.9419255350708233, -0.047913243871074984, 0.2160731914052918, 0.6132057610123631, -0.1483252161201276, 0.19962989834879563, 0.6526343893985262, -0.8377169376092328, 0.03945193428795757, 0.27137889212789257, 0.1254944766988415, -0.11771942536833913, -0.13740686337107322, -0.5617675251685137, 0.7032288492162357, 0.3016023307491442, 0.42197761108254017, -0.053616332405617584, -0.3145510508749696, -0.2503780894118248, 0.2669926760177723, 0.5704371802330073, 0.19636321444910387, -0.4726987562736813, -0.24409857803712587, 0.3209578788465337, -0.2781242597283762, -0.731271758673744, -0.25742285693936906, -0.19484669042501412, -0.9487497099037259, 0.010501603004986926, 0.6366449293224656, -0.5531530109672302, -0.8153968729184686, -0.24072727422210471, 0.44127442597785604, 0.5289394518327108, 0.6732742001684444, 0.09167116721042223, 0.6164136997871228, 0.7466988414130609, 0.8702285480412169, -0.3711391335124672, -0.7152358089356634, 0.07060778034488058, 0.7076486005045513, 0.9152177676390709, 0.02010862154499593, -0.6176471433654322, -0.1912732947556457, 0.5987034646879414, -0.6248674687294185, 0.054391483184376366};
  element_t correct_raw[] = {0.202278,-0.413227,-0.354936,0.071175,0.254596,0.356969,-1.724079,0.179591,-0.388113,-0.508384,-0.719402,-0.127718,1.509782,0.807293,0.367445,0.780133,-0.690215,0.258549,-2.064074,-0.618952,0.647542,0.457253,-0.683379,-0.964728,-0.489620,0.706794,0.696435,-0.855779,1.153164,-0.856526,0.187029,-0.639243,-0.633383,-0.069273,-0.144940,-0.640437,0.224954,0.986641,-0.062080,0.631837,-0.347017,0.892069,0.132971,-0.164858,-0.768633,-0.856389,0.086035,-0.362570,-0.479465,0.007831,-0.071740,0.435145,-0.282618,0.041320,-0.142954,-0.435339,-0.652365,0.123451,0.520815,-0.246259,0.282251,-0.740648,0.269701,-0.551534,-0.015769,-0.667124,-1.625015,0.229210,-0.129213,-0.303816,-0.368752,0.587485,1.187934,0.372361,-0.181713,0.162206,-0.935678,0.266474,-0.517233,-0.958486,0.645372,-0.900399,-0.340318,-0.552895,-0.306767,-0.057752,-0.830961,0.345924,-0.155663,-0.645881,0.316628,0.696875,-0.161932,0.324314,0.715808,-0.716332,0.380281,-0.569850,0.086567,-0.694206,-0.767893,0.646621,0.716895,0.627483,0.243657,0.715455,-0.803748,-0.167367,0.016432,-0.983836,-1.107276,0.429284,0.273345,-0.760840,0.702415,-0.418515,0.514438,-0.984864,0.113967,0.197559,0.111359,-0.567602,0.339926,0.590072,0.856653,-0.435969,0.258963,0.567433,-0.001369,0.455220,0.585523,-0.652472,-1.010055,-0.645322,0.549096,-0.546950,0.624224,0.005295,-0.195747,1.119844,0.376505,-0.892382,0.978386,0.921298,-0.067223,0.649493,0.512349,-0.879007,0.319672,-0.584814,-0.828399,-0.885851,-0.227578,0.081806,-0.556477,-0.963406,0.640665,-1.077439,0.157766,-0.206288,-0.674507,-0.549898,-0.111665,0.948856,0.377883,-0.922624,0.481446,0.004754,0.924213,0.070609,-0.645871,-0.200864,0.205757,0.725859,-0.734392,-0.781631,-1.249132,-0.186027,-1.322717,-0.887940,-0.706032,-0.834026,0.122401,-0.635772,-0.579981,-0.147219,-0.043746,-0.529340,0.351145,-0.022709,-0.509622,0.807402,0.447389,-1.123785,-0.710080,-0.040411,0.671819,-0.739595,-0.115764,0.719099,-0.293165,0.729783,-0.888867,-0.833956,0.263457,-0.265715,0.680845,0.805208,0.423534,-0.645291,-0.463311,-0.851200,0.275533,0.114505,-0.014942,0.290754,0.512282,-0.150817,1.067474,0.862256,-0.983836,-0.696113,-0.885936,0.958729,0.002350,-0.797022,0.880901,-0.493118,-0.429155,0.038208,-0.262719,-0.641948,-0.123220,-0.995586,-1.007164,-0.161334,0.350017,0.984479,-0.041119,0.208860,0.758104,-0.946651,0.048261,0.517826,-0.152627,-0.345623,-0.157000,-0.673392,0.713654,-0.185120,0.038653,-0.340305,-0.310311,-0.197044,0.277388,0.875707,0.193633,-0.370059,-0.211812,0.256673,-0.249028,-1.155392,-0.257194,-0.041561,-1.073073,0.004722,0.676559,-0.154689,-0.813485,-0.605526,0.348250,0.459863,0.706522,-0.135280,0.632200,0.792827,0.881472,-0.284674,-0.698740,0.343666,0.662697,0.797101,0.014944,-0.649882,-0.180247,0.905142,-0.599106,0.118952};

  auto& ms = MinervaSystem::Instance();
  Scale bottom_size{2, 3, 24, 2};
  shared_ptr<element_t> bottom_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  shared_ptr<element_t> top_diff_ptr(new element_t[bottom_size.Prod()], [](element_t* ptr) { delete[] ptr; });
  memcpy(bottom_ptr.get(), bottom_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_ptr.get(), top_raw, bottom_size.Prod() * sizeof(element_t));
  memcpy(top_diff_ptr.get(), top_diff_raw, bottom_size.Prod() * sizeof(element_t));
  ms.SetDevice(cpu_device);
  ImageBatch bottom = NArray::MakeNArray(bottom_size, bottom_ptr);
  ImageBatch top = NArray::MakeNArray(bottom_size, top_ptr);
  ImageBatch top_diff = NArray::MakeNArray(bottom_size, top_diff_ptr);
  ImageBatch scale = NArray::Ones(bottom_size);
  int local_size = 12;
  element_t alpha = 0.3;
  element_t beta = 0.75;
  ImageBatch bottom_diff = Convolution::LRNBackward(bottom, top, scale, top_diff, local_size, alpha, beta);
  auto bottom_diff_ptr = bottom_diff.Get();
  for (int i = 0; i < bottom_size.Prod(); ++i) {
    EXPECT_NEAR(bottom_diff_ptr.get()[i], correct_raw[i], 0.001);
    //printf("%f,",bottom_diff_ptr.get()[i]);
  }
}

